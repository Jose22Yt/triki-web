<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRIKI — Tres en Raya</title>
  <!--
    Juego de tres en raya (triki) con opciones avanzadas de personalización.
    Este archivo combina todo el HTML, CSS y JavaScript en un único documento
    para facilitar su publicación en servicios estáticos como GitHub Pages.
    
    Funciones implementadas:
    - Tablero 3×3 con estilos glass/neón.
    - IA básica con modo Jugador vs IA y IA vs IA (autoplay).
    - Panel de ajustes para:
        * Cambiar colores (temas) mediante variables CSS.
        * Ajustar animaciones (activar/desactivar).
        * Ajustar espaciado y radio de las celdas.
        * Personalizar el tamaño de las marcas (X/O) y sus colores.
        * Activar/desactivar sonido y ajustar volumen.
    - Importar/exportar temas en formato JSON.
    - Pantalla de registro/inicio de sesión local (guardada en localStorage).
  -->
  <style>
    :root{
      /* Colores base del fondo */
      --bg1:#6c2bd9;
      --bg2:#b02bd9;
      /* Colores de los paneles */
      --panel:#ff56e0;
      --panel2:#ff7cf0;
      /* Efectos glass */
      --glass: rgba(255,255,255,.16);
      --glass2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.25);
      /* Tipografía */
      --text:#ffffff;
      --muted: rgba(255,255,255,.78);
      /* Colores de X y O */
      --x:#3a3f95;
      --o:#ffffff;
      /* Imagen de fondo personalizada (url(...) o none) */
      --wallpaper:none;
      /* Ajustes de tablero */
      --cell-gap:18px;
      --cell-radius:18px;
      --cell-size:78px;
      --board-border:2px;
      /* Ajuste de escala de las marcas (1 = tamaño normal) */
      --mark-scale:1;
      /* Animaciones: 1 = activadas, 0 = desactivadas */
      --anim-enabled:1;
      /* Sonido */
      --volume:0.2;
      /* Colores para la barra de navegación inferior y botones de navegación. Se actualizan dinámicamente
         en función de si existe un wallpaper o no (ver applyCssVars). Establecemos valores iniciales para
         evitar que queden sin definir. */
      --navBg: rgba(0,0,0,.25);
      --navBtnBg: rgba(0,0,0,.32);
      --navBtnBgActive: rgba(0,0,0,.45);
      /* Navegación inferior */
      --navH:78px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      min-height:100vh;
      /* Fondo degradado; la imagen personalizada se aplica dinámicamente via JS */
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:18px 14px calc(var(--navH) + 14px + env(safe-area-inset-bottom,0px));
    }
    .app{width:min(520px,100%);}
    .hidden{display:none !important;}
    /* Encabezado */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:14px;
      margin-top:8px;
    }
    .title h1{margin:0;font-size:54px;letter-spacing:.5px;font-weight:900;line-height:.95;}
    .title .sub{margin-top:10px;font-size:24px;color:var(--muted);font-weight:500;}
    /* Tarjeta principal */
    .card{
      margin-top:22px;
      border-radius:28px;
      background:linear-gradient(180deg,color-mix(in srgb,var(--panel2) 86%,white 14%),var(--panel));
      box-shadow:0 18px 60px rgba(0,0,0,.28);
      border:var(--board-border) solid color-mix(in srgb,var(--glass2) 70%,transparent);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    /* Pastilla de turno */
    .turnPillWrap{display:flex;justify-content:center;margin-top:6px;}
    .turnPill{
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:12px 26px;
      border-radius:999px;
      background:color-mix(in srgb,var(--glass) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 90%,transparent);
      box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--glass2) 90%,transparent);
      font-weight:900;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .turnPill .mark{
      display:inline-grid;
      place-items:center;
      min-width:34px;height:34px;
      border-radius:999px;
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 70%,transparent);
      font-size:22px;font-weight:1000;
    }
    /* Tablero */
    .boardShell{
      margin-top:18px;
      border-radius:30px;
      padding:18px;
      background:color-mix(in srgb,var(--glass) 92%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 70%,transparent);
      box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--glass2) 85%,transparent);
    }
    .board{
      width:100%;
      aspect-ratio:1/1;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:var(--cell-gap);
      padding:10px;
      border-radius:26px;
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 65%,transparent);
    }
    .cell{
      border-radius:var(--cell-radius);
      background:color-mix(in srgb,var(--glass) 92%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 78%,transparent);
      box-shadow:0 18px 34px rgba(0,0,0,.10);
      display:grid;
      place-items:center;
      min-height:var(--cell-size);
      font-weight:1000;
      font-size:clamp(34px,8vw,54px);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      transition:transform .15s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      position:relative;
      overflow:hidden;
    }
    .anim-off .cell{transition:none !important;}
    .cell:hover{transform:translateY(-1px);background:color-mix(in srgb,var(--glass) 110%,transparent);border-color:color-mix(in srgb,var(--stroke) 92%,transparent);}
    .cell:active{transform:translateY(0px) scale(.98);}
    .cell.disabled{cursor:not-allowed;opacity:.78;}
    .cell.win{background:color-mix(in srgb,var(--glass) 145%,transparent);border-color:color-mix(in srgb,var(--stroke) 140%,transparent);box-shadow:0 24px 44px rgba(0,0,0,.16);}
    .markX{color:var(--x);text-shadow:0 10px 22px rgba(0,0,0,.20);transform:scale(var(--mark-scale));}
    .markO{color:var(--o);text-shadow:0 10px 22px rgba(0,0,0,.20);transform:scale(var(--mark-scale));}
    /* Botones */
    /* Botones principales: se distribuyen automáticamente en columnas adaptables y
       utilizan tamaños más contenidos para adaptarse mejor a pantallas móviles. */
    .buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:14px;
    }
    /* Ajustar solo los botones principales dentro de .buttons para que se distribuyan en 3 columnas */
    .buttons .btn{
      flex:1 1 calc(33.333% - 8px);
      min-width:90px;
    }
    .btn{
      border-radius:18px;
      padding:14px 10px;
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 60%,transparent);
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      color:var(--text);
      font-weight:700;
      font-size:20px;
      box-shadow:0 12px 28px rgba(0,0,0,.14);
      cursor:pointer;
      transition:transform .18s cubic-bezier(.22,1,.36,1), background .20s ease, border-color .20s ease;
    }
    .btn:hover{transform:translateY(-1px);background:color-mix(in srgb,var(--glass) 78%,transparent);border-color:color-mix(in srgb,var(--stroke) 80%,transparent);}
    .btn:active{transform:translateY(0px) scale(.98);}
    .btn.smallText{font-size:22px;}
    /* Marcador */
    .score{margin-top:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    /* Animación de victoria y confeti */
    .winOverlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:1000;}
    .winOverlay .message{font-size:48px;font-weight:700;color:var(--text);text-shadow:0 0 12px rgba(0,0,0,.4);animation:popWin .6s ease forwards;}
    @keyframes popWin{0%{transform:scale(0.5);opacity:0;}100%{transform:scale(1);opacity:1;}}
    .confetti{position:fixed;width:8px;height:8px;border-radius:50%;opacity:0;animation:confFall linear;}
    @keyframes confFall{0%{transform:translateY(-10px) rotate(0deg);opacity:1;}100%{transform:translateY(100vh) rotate(360deg);opacity:0;}}
    .scoreCard{
      border-radius:18px;
      padding:14px 12px;
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 58%,transparent);
      box-shadow:0 12px 26px rgba(0,0,0,.10);
      text-align:center;
    }
    .scoreCard .label{font-size:20px;margin-bottom:4px;color:var(--muted);}    
    .scoreCard .value{font-size:28px;font-weight:900;}
    /* Barra inferior */
    .nav{
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      height:calc(var(--navH) + env(safe-area-inset-bottom,0px));
      padding-bottom:env(safe-area-inset-bottom,0px);
      background:color-mix(in srgb,var(--navBg) 100%,transparent);
      backdrop-filter:blur(12px);
      display:flex;
      justify-content:space-around;
      align-items:center;
      border-top:1px solid color-mix(in srgb,var(--stroke) 45%,transparent);
      box-shadow:0 -10px 20px rgba(0,0,0,.25);
      z-index:10;
    }
    .nav button{
      appearance:none;
      background:color-mix(in srgb,var(--navBtnBg) 100%,transparent);
      border:2px solid color-mix(in srgb,var(--stroke) 50%,transparent);
      border-radius:16px;
      padding:12px;
      color:var(--text);
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background .18s ease,border-color .18s ease;
    }
    .nav button.active, .nav button:hover{
      background:color-mix(in srgb,var(--navBtnBgActive) 100%,transparent);
      border-color:color-mix(in srgb,var(--stroke) 80%,transparent);
    }

    /* --- Capas de personalización y efectos --- */
    /* Lista de categorías para la pantalla de personalización */
    #styleModal .modalCard{
      background:color-mix(in srgb,var(--panel2) 86%,white 14%);
      border-radius:28px;
      padding:20px;
      max-width:90%;
      width:480px;
      max-height:90vh;
      overflow:auto;
      position:relative;
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.30);
    }
    .styleItem{
      display:flex;
      align-items:center;
      gap:14px;
      margin-top:14px;
      padding:16px;
      border-radius:20px;
      background:color-mix(in srgb,var(--glass2) 96%,transparent);
      border:1px solid color-mix(in srgb,var(--stroke) 60%,transparent);
      cursor:pointer;
      transition:background .2s ease,border-color .2s ease;
    }
    .styleItem:hover{
      background:color-mix(in srgb,var(--glass) 100%,transparent);
      border-color:color-mix(in srgb,var(--stroke) 80%,transparent);
    }
    .styleItemIcon svg{
      width:28px;
      height:28px;
      stroke-width:2;
      stroke:var(--text);
      fill:none;
    }
    .styleItemContent .title{
      font-size:20px;
      font-weight:700;
      color:var(--text);
    }
    .styleItemContent .subtitle{
      font-size:14px;
      color:var(--muted);
    }
    /* Modal de efectos visuales */
    #effectsModal .modalCard{
      background:color-mix(in srgb,var(--panel2) 86%,white 14%);
      border-radius:28px;
      padding:20px;
      max-width:90%;
      width:480px;
      max-height:90vh;
      overflow:auto;
      position:relative;
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.30);
    }
    /* Capa de ruido para el efecto Film grain */
    #noiseLayer{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      pointer-events:none;
      z-index:-1;
      background-image:
        repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 4px),
        repeating-linear-gradient(-45deg, rgba(0,0,0,0.03) 0px, rgba(0,0,0,0.03) 3px, transparent 3px, transparent 6px);
      background-size:100% 100%;
      opacity:.5;
      display:none;
    }
    /* Efecto glow dinámico: añade resplandor a las celdas cuando está activado */
    body.glow-on .cell::after{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      border-radius:inherit;
      box-shadow:0 0 20px 4px color-mix(in srgb,var(--panel2) 70%,transparent);
      pointer-events:none;
      z-index:-1;
    }
    /* Modales */
    .modal{
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      display:none;
      justify-content:center;
      align-items:center;
      background:rgba(0,0,0,.5);
      z-index:11;
    }
    .modal.active{display:flex;}
    .modalCard{
      background:color-mix(in srgb,var(--panel2) 86%,white 14%);
      border-radius:28px;
      padding:20px;
      max-width:90%;
      width:480px;
      max-height:90vh;
      overflow:auto;
      position:relative;
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.30);
    }
    .modalCard h2{margin-top:0;font-size:32px;}
    .closeBtn{
      position:absolute;
      top:12px;right:12px;
      background:none;
      border:none;
      color:var(--text);
      font-size:28px;
      cursor:pointer;
    }
    .modalCard label{display:block;margin-top:14px;font-size:16px;color:var(--muted);}    
    .modalCard input[type="number"], .modalCard input[type="text"], .modalCard input[type="password"], .modalCard input[type="color"], .modalCard select{
      width:100%;
      margin-top:6px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid color-mix(in srgb,var(--stroke) 60%,transparent);
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      color:var(--text);
      font-size:16px;
    }
    .modalCard input[type="checkbox"]{margin-right:8px;}
    .modalCard button{margin-top:20px;width:100%;padding:10px;border-radius:12px;background:color-mix(in srgb,var(--navBtnBg) 100%,transparent);border:2px solid color-mix(in srgb,var(--stroke) 50%,transparent);color:var(--text);font-size:18px;cursor:pointer;transition:background .18s ease,border-color .18s ease;}
    .modalCard button:hover{background:color-mix(in srgb,var(--navBtnBgActive) 100%,transparent);border-color:color-mix(in srgb,var(--stroke) 80%,transparent);}

    /* Animación de pulsación para botones y celdas */
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.12); }
      100% { transform: scale(1); }
    }
    .pop {
      animation: pop var(--pop-speed, 0.3s) ease;
    }
    .sectionTitle{margin-top:24px;font-weight:700;font-size:18px;color:var(--text);}    
    /* Autenticación */
    #authGate{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #authGate.hidden{display:none;}
    #authGateCard{
      background:color-mix(in srgb,var(--panel2) 86%,white 14%);
      border-radius:28px;
      padding:24px;
      max-width:90%;
      width:400px;
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.30);
    }
    #authGateCard h2{margin-top:0;font-size:28px;}
    #authGateCard input{width:100%;margin-top:10px;padding:10px;border-radius:8px;border:1px solid color-mix(in srgb,var(--stroke) 60%,transparent);background:color-mix(in srgb,var(--glass2) 100%,transparent);color:var(--text);font-size:16px;}
    #authGateCard button{width:100%;margin-top:16px;padding:12px;border-radius:12px;background:color-mix(in srgb,var(--navBtnBg) 100%,transparent);border:2px solid color-mix(in srgb,var(--stroke) 50%,transparent);color:var(--text);font-size:18px;cursor:pointer;transition:background .18s ease,border-color .18s ease;}
    #authGateCard button:hover{background:color-mix(in srgb,var(--navBtnBgActive) 100%,transparent);border-color:color-mix(in srgb,var(--stroke) 80%,transparent);}
  </style>
</head>
<body>
  <!-- Autenticación -->
  <div id="authGate">
    <div id="authGateCard">
      <h2 id="authTitle">Crear cuenta</h2>
      <input id="authUser" type="text" placeholder="Usuario" />
      <input id="authPass" type="password" placeholder="Contraseña" />
      <button id="authBtn">Crear cuenta</button>
      <p id="authMsg" style="margin-top:10px;color:#ffcccc;font-size:14px;display:none;"></p>
      <!-- Permitir cambiar entre registro e inicio de sesión -->
      <p id="switchAuth" style="margin-top:12px;font-size:14px;text-align:center;text-decoration:underline;cursor:pointer;">
        ¿Ya tienes cuenta? Iniciar sesión / Crear cuenta
      </p>
    </div>
  </div>
  <!-- Aplicación principal -->
  <div class="app hidden" id="app">
    <div class="top">
      <div class="title">
        <h1>TRIKI</h1>
        <div class="sub">Tres en Raya</div>
      </div>
    </div>
    <div class="card">
      <!-- Turno -->
      <div class="turnPillWrap">
        <div class="turnPill"><span>TURNO:</span> <span class="mark" id="turnMark">X</span></div>
      </div>
      <!-- Tablero -->
      <div class="boardShell">
        <div class="board" id="board">
          <!-- Las celdas se generan dinámicamente -->
        </div>
      </div>
      <!-- Botones principales -->
      <div class="buttons">
        <button class="btn" id="btnReset">Reiniciar</button>
        <button class="btn" id="btnNext">Nueva Ronda</button>
        <button class="btn" id="btnResetAll">Reiniciar Todo</button>
      </div>
      <!-- Marcador -->
      <div class="score">
        <div class="scoreCard">
          <div class="label">X</div>
          <div class="value" id="scoreX">0</div>
        </div>
        <div class="scoreCard">
          <div class="label">Empates</div>
          <div class="value" id="scoreD">0</div>
        </div>
        <div class="scoreCard">
          <div class="label">O</div>
          <div class="value" id="scoreO">0</div>
        </div>
      </div>
    </div>
    <!-- Barra inferior de navegación -->
    <div class="nav">
      <button id="homeBtn" class="active">
        <!-- Icono Home (casa) -->
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 10.5L12 3l9 7.5v9a2 2 0 0 1-2 2h-5v-6h-4v6H5a2 2 0 0 1-2-2v-9z" />
        </svg>
      </button>
      <button id="settingsBtn">
        <!-- Icono Ajustes (engranaje simplificado) -->
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a2 2 0 0 0 .4 2.2l.1.1a2 2 0 0 1-2.1 3.3l-.3 0a2 2 0 0 0-2.1 1.7v.3a2 2 0 0 1-3.8 0l-.2-.6a2 2 0 0 0-1.8-1.4h-.4a2 2 0 0 0-1.8 1.4l-.2.6a2 2 0 0 1-3.8 0l-.3 0a2 2 0 0 1-2.1-3.3l.1-.1a2 2 0 0 0 .4-2.2l-2-1.5a2 2 0 0 1 1.3-3.5h.3a2 2 0 0 0 2.1-1.7l.2-.7a2 2 0 0 1 3.8 0l.2.7a2 2 0 0 0 1.8 1.4h.4a2 2 0 0 0 1.8-1.4l.2-.7a2 2 0 0 1 3.8 0l.3 0a2 2 0 0 0 2.1 1.7h.3a2 2 0 0 1 1.3 3.5l-2 1.5z" />
        </svg>
      </button>
      <button id="themeBtn">
        <!-- Icono Paleta de colores -->
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 21c-5 0-9-3.8-9-7.6 0-2.3 1.9-4.1 4-4.9 0-.4-.1-.8-.1-1.2C6.9 4.2 9.9 1 13.2 1c3.3 0 6.1 2.6 6.3 6.1 2.2.7 3.9 2.7 3.9 5 0 4.3-4.4 7.9-9.4 7.9h-2z" />
          <circle cx="8.5" cy="10" r="1.5" />
          <circle cx="14.5" cy="8" r="1.5" />
          <circle cx="15.5" cy="13.5" r="1.5" />
          <circle cx="9.5" cy="14" r="1.5" />
        </svg>
      </button>
      <button id="soundBtn">
        <!-- Icono Sonido (altavoz) -->
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="3 9 9 9 13 5 13 19 9 15 3 15 3 9" />
          <path d="M16 8.5a3.5 3.5 0 0 1 0 7" />
          <path d="M18.5 6a6 6 0 0 1 0 12" />
        </svg>
      </button>
    </div>

    <!-- Capa de ruido para film grain (activada mediante efectos visuales) -->
    <div id="noiseLayer"></div>

    <!-- Modal de Personalización (estilo) -->
    <div class="modal" id="styleModal">
      <div class="modalCard">
        <button class="closeBtn" id="closeStyle">✕</button>
        <h2>Personalizar</h2>
        <!-- Lista de categorías -->
        <div class="styleItem" data-target="theme">
          <div class="styleItemIcon">
            <!-- Icono paleta -->
            <svg viewBox="0 0 24 24">
              <path d="M12 21c-5 0-9-3.8-9-7.6 0-2.3 1.9-4.1 4-4.9 0-.4-.1-.8-.1-1.2C6.9 4.2 9.9 1 13.2 1c3.3 0 6.1 2.6 6.3 6.1 2.2.7 3.9 2.7 3.9 5 0 4.3-4.4 7.9-9.4 7.9h-2z" />
              <circle cx="8.5" cy="10" r="1.5" />
              <circle cx="14.5" cy="8" r="1.5" />
              <circle cx="15.5" cy="13.5" r="1.5" />
              <circle cx="9.5" cy="14" r="1.5" />
            </svg>
          </div>
          <div class="styleItemContent">
            <div class="title">Temas</div>
            <div class="subtitle">Apariencia visual</div>
          </div>
        </div>
        <div class="styleItem" data-target="icons">
          <div class="styleItemIcon">
            <!-- Icono para iconos X/O: círculo y cruz -->
            <svg viewBox="0 0 24 24">
              <circle cx="8" cy="12" r="3" />
              <line x1="14" y1="9" x2="20" y2="15"></line>
              <line x1="20" y1="9" x2="14" y2="15"></line>
            </svg>
          </div>
          <div class="styleItemContent">
            <div class="title">Iconos X/O</div>
            <div class="subtitle">Estilo y color</div>
          </div>
        </div>
        <div class="styleItem" data-target="board">
          <div class="styleItemIcon">
            <!-- Icono del tablero: cuadrados superpuestos -->
            <svg viewBox="0 0 24 24">
              <rect x="3" y="3" width="6" height="6"></rect>
              <rect x="9" y="9" width="6" height="6"></rect>
              <rect x="15" y="15" width="6" height="6"></rect>
            </svg>
          </div>
          <div class="styleItemContent">
            <div class="title">Estilo del tablero</div>
            <div class="subtitle">iOS Glass y más</div>
          </div>
        </div>
        <div class="styleItem" data-target="wallpaper">
          <div class="styleItemIcon">
            <!-- Icono de fondo personalizado: foto/montaña -->
            <svg viewBox="0 0 24 24">
              <rect x="3" y="4" width="18" height="14" rx="2" ry="2"></rect>
              <circle cx="9" cy="10" r="2"></circle>
              <polyline points="21 14 16 10 12 14 3 7"></polyline>
            </svg>
          </div>
          <div class="styleItemContent">
            <div class="title">Fondo personalizado</div>
            <div class="subtitle">Imagen de galería</div>
          </div>
        </div>
        <div class="styleItem" data-target="effects">
          <div class="styleItemIcon">
            <!-- Icono de efectos: estrella con destellos -->
            <svg viewBox="0 0 24 24">
              <path d="M12 2l1.4 4.2L18 6l-3.3 3.5L15 14l-3-2.2L9 14l.3-4.5L6 6l4.6-.8L12 2z"></path>
              <circle cx="19" cy="3" r="1.5"></circle>
              <circle cx="4" cy="17" r="1.5"></circle>
            </svg>
          </div>
          <div class="styleItemContent">
            <div class="title">Efectos visuales</div>
            <div class="subtitle">Partículas y animación</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de efectos visuales -->
    <div class="modal" id="effectsModal">
      <div class="modalCard">
        <button class="closeBtn" id="closeEffects">✕</button>
        <h2>Efectos visuales</h2>
        <label>Ruido / Film grain
          <input type="checkbox" id="noiseEnabled" />
        </label>
        <label>Glow dinámico
          <input type="checkbox" id="glowEnabled" />
        </label>
        <label>Celebración al ganar (confeti)
          <input type="checkbox" id="confettiEnabled" checked />
        </label>
        <button id="applyEffects">Aplicar</button>
        <button id="backEffects">Volver</button>
      </div>
    </div>
  </div>
  <!-- Modal de Ajustes del Juego -->
  <div class="modal" id="settingsModal">
    <div class="modalCard">
      <button class="closeBtn" id="closeSettings">✕</button>
      <h2>Ajustes</h2>
      <div class="sectionTitle">Modo de juego</div>
      <label>Modo de Juego
        <select id="modeSelect">
          <option value="pvsp">2 Jugadores (local)</option>
          <option value="pvai">Jugador vs IA</option>
          <option value="aivsa">IA vs IA (autoplay)</option>
        </select>
      </label>
      <label>Tiempo de espera IA (ms)
        <input type="number" id="aiDelay" value="600" min="100" step="100" />
      </label>
      <div class="sectionTitle">Animaciones</div>
      <label>Animaciones activadas
        <input type="checkbox" id="animEnabled" checked />
      </label>
      <label>Velocidad del pulso (s)
        <input type="number" id="animSpeed" value="0.3" min="0.1" max="1" step="0.1" />
      </label>
      <div class="sectionTitle">Tablero</div>
      <label>Espacio entre celdas (px)
        <input type="number" id="gapInput" value="18" min="0" max="40" />
      </label>
      <label>Radio de celdas (px)
        <input type="number" id="radiusInput" value="18" min="0" max="40" />
      </label>
      <label>Escala ficha (X/O)
        <input type="number" id="markScaleInput" value="1" step="0.1" min="0.5" max="2" />
      </label>
      <div class="sectionTitle">Símbolos</div>
      <label>Color X
        <input type="color" id="colorX" value="#3a3f95" />
      </label>
      <label>Color O
        <input type="color" id="colorO" value="#ffffff" />
      </label>
      <button id="applySettings">Aplicar</button>
      <button id="resetSettings">Restaurar valores</button>

      <!-- Botón para volver a la pantalla principal -->
      <button id="backSettings">Volver</button>
    </div>
  </div>
  <!-- Modal de Temas -->
  <div class="modal" id="themeModal">
    <div class="modalCard">
      <button class="closeBtn" id="closeTheme">✕</button>
      <h2>Tema</h2>
      <p>Colores actuales. Cambia y guarda tu propio tema:</p>
      <label>Color fondo arriba
        <input type="color" id="themeBg1" value="#6c2bd9" />
      </label>
      <label>Color fondo abajo
        <input type="color" id="themeBg2" value="#b02bd9" />
      </label>
      <label>Panel principal
        <input type="color" id="themePanel" value="#ff56e0" />
      </label>
      <label>Panel secundario
        <input type="color" id="themePanel2" value="#ff7cf0" />
      </label>
      <button id="applyTheme">Aplicar tema</button>
      <button id="resetTheme">Restaurar tema</button>
      <div class="sectionTitle">Tema en JSON (importar / exportar)</div>
      <label>Editor JSON
        <textarea id="themeJson" rows="6" style="width:100%;margin-top:8px;padding:10px;border-radius:8px;background:color-mix(in srgb,var(--glass2) 100%,transparent);border:1px solid color-mix(in srgb,var(--stroke) 60%,transparent);color:var(--text);"></textarea>
      </label>
      <button id="applyThemeJson">Aplicar JSON</button>
      <button id="copyThemeJson">Copiar JSON</button>
      <button id="exportThemeJson">Exportar .json</button>
      <input type="file" id="importThemeFile" accept="application/json" style="display:none;" />
      <button id="importThemeJson">Importar .json</button>

      <!-- Fondo personalizado -->
      <div class="sectionTitle">Fondo de pantalla</div>
      <button id="selectWallpaper">Seleccionar imagen</button>
      <button id="clearWallpaper">Quitar fondo</button>
      <input type="file" id="wallpaperInput" accept="image/*" style="display:none;" />
      <!-- El fondo se aplica completo; control de parallax para efecto 3D -->
      <!-- Control del efecto parallax 4D para el fondo. Este deslizador ajusta la
           intensidad del desplazamiento del wallpaper al mover el ratón. Un
           valor mayor aumenta el efecto 4D. -->
      <label>Parallax (efecto 4D)
        <input type="range" id="themeParallax" min="0" max="40" step="1" value="0" />
      </label>

      <!-- Botón para aplicar el tema y regresar -->
      <button id="applyThemeAndReturn">Aplicar y volver</button>
      <!-- Botón para volver a la pantalla principal sin aplicar cambios -->
      <button id="backTheme">Volver</button>
    </div>
  </div>
  <!-- Modal de Sonido -->
  <div class="modal" id="soundModal">
    <div class="modalCard">
      <button class="closeBtn" id="closeSound">✕</button>
      <h2>Sonido</h2>
      <label>Audio activado
        <input type="checkbox" id="soundEnabled" checked />
      </label>
      <label>Volumen
        <input type="number" id="soundVolume" min="0" max="1" step="0.05" value="0.2" />
      </label>
      <!-- Sección de efectos de sonido -->
      <div class="sectionTitle">Efectos</div>
      <label>Sonido al mover
        <input type="checkbox" id="moveSoundEnabled" checked />
      </label>

      <button id="applySound">Aplicar</button>

      <!-- Botón para volver a la pantalla principal -->
      <button id="backSound">Volver</button>
    </div>
  </div>
  <script>
    // Estado del juego y configuración
    const state = {
      board:Array(9).fill(''),
      turn:'X',
      scores:{X:0,O:0,D:0},
      settings:{
        mode:'pvsp',
        aiDelay:600,
        anim:true,
        animSpeed:0.3,
        cellGap:18,
        cellRadius:18,
        markScale:1,
        xColor:'#3a3f95',
        oColor:'#ffffff',
        // Añadimos "parallax" para controlar el efecto 3D del fondo
        theme:{bg1:'#6c2bd9',bg2:'#b02bd9',panel:'#ff56e0',panel2:'#ff7cf0',wallpaper:'',parallax:0},
        sound:{enabled:true,volume:0.2,moveSoundEnabled:true},
        // Efectos visuales: ruido (film grain), glow dinámico y confeti al ganar
        effects:{noise:false,glow:false,confetti:true}
      },
      lastMove:null,
      playing:true
    };

    // Claves de localStorage
    const STORAGE_USER='trikiUser';
    const STORAGE_PWD='trikiPwd';
    const STORAGE_SETTINGS='trikiSettings';

    // Dom
    const boardEl=document.getElementById('board');
    const turnMark=document.getElementById('turnMark');
    const scoreX=document.getElementById('scoreX');
    const scoreO=document.getElementById('scoreO');
    const scoreD=document.getElementById('scoreD');
    const appEl=document.getElementById('app');
    const authGate=document.getElementById('authGate');
    const authTitle=document.getElementById('authTitle');
    const authUser=document.getElementById('authUser');
    const authPass=document.getElementById('authPass');
    const authBtn=document.getElementById('authBtn');
    const authMsg=document.getElementById('authMsg');
    // Modales
    const settingsModal=document.getElementById('settingsModal');
    const themeModal=document.getElementById('themeModal');
    const soundModal=document.getElementById('soundModal');
    const styleModal=document.getElementById('styleModal');
    const effectsModal=document.getElementById('effectsModal');
    // Nav
    const homeBtn=document.getElementById('homeBtn');
    const settingsBtn=document.getElementById('settingsBtn');
    const themeBtn=document.getElementById('themeBtn');
    const soundBtn=document.getElementById('soundBtn');
    // Capa de ruido
    const noiseLayer=document.getElementById('noiseLayer');
    // Estilo (personalizar) items
    const closeStyle=document.getElementById('closeStyle');
    const closeEffects=document.getElementById('closeEffects');
    const noiseEnabled=document.getElementById('noiseEnabled');
    const glowEnabled=document.getElementById('glowEnabled');
    const confettiEnabled=document.getElementById('confettiEnabled');
    const applyEffectsBtn=document.getElementById('applyEffects');
    const backEffects=document.getElementById('backEffects');
    // Ajustes UI
    const modeSelect=document.getElementById('modeSelect');
    const aiDelay=document.getElementById('aiDelay');
    const animEnabled=document.getElementById('animEnabled');
    // velocidad de animación (pulso)
    const animSpeedInput=document.getElementById('animSpeed');
    const gapInput=document.getElementById('gapInput');
    const radiusInput=document.getElementById('radiusInput');
    const markScaleInput=document.getElementById('markScaleInput');
    const colorX=document.getElementById('colorX');
    const colorO=document.getElementById('colorO');
    const applySettingsBtn=document.getElementById('applySettings');
    const resetSettingsBtn=document.getElementById('resetSettings');
    // Tema UI
    const themeBg1=document.getElementById('themeBg1');
    const themeBg2=document.getElementById('themeBg2');
    const themePanel=document.getElementById('themePanel');
    const themePanel2=document.getElementById('themePanel2');
// Control para el efecto parallax del fondo
const themeParallax=document.getElementById('themeParallax');
    const applyThemeBtn=document.getElementById('applyTheme');
    const resetThemeBtn=document.getElementById('resetTheme');
    // Botón que aplica el tema y regresa a la pantalla principal
    const applyThemeAndReturnBtn=document.getElementById('applyThemeAndReturn');
    const themeJson=document.getElementById('themeJson');
    const applyThemeJsonBtn=document.getElementById('applyThemeJson');
    const copyThemeJsonBtn=document.getElementById('copyThemeJson');
    const exportThemeJsonBtn=document.getElementById('exportThemeJson');
    const importThemeJsonBtn=document.getElementById('importThemeJson');
    const importThemeFile=document.getElementById('importThemeFile');
    // Fondo UI
    const selectWallpaper=document.getElementById('selectWallpaper');
    const clearWallpaper=document.getElementById('clearWallpaper');
    const wallpaperInput=document.getElementById('wallpaperInput');
    // Se eliminaron los controles y listeners de opacidad de fondo; la imagen se aplica completa
    // Botones de volver en modales
    const backSettings=document.getElementById('backSettings');
    const backTheme=document.getElementById('backTheme');
    const backSound=document.getElementById('backSound');

    // Botón para alternar entre crear cuenta e iniciar sesión (borrar cuenta)
    const switchAuthBtn=document.getElementById('switchAuth');
    // Sonido UI
    const soundEnabled=document.getElementById('soundEnabled');
    const soundVolume=document.getElementById('soundVolume');
    // Checkbox de sonido al mover
    const moveSoundEnabled=document.getElementById('moveSoundEnabled');
    const applySoundBtn=document.getElementById('applySound');

    // Si el usuario desea cambiar de cuenta o crear una nueva, este botón borra las credenciales almacenadas
    // y vuelve a mostrar la pantalla de autenticación. Esto facilita crear una nueva cuenta si ya existe una previa.
    if(switchAuthBtn){
      switchAuthBtn.addEventListener('click',()=>{
        localStorage.removeItem(STORAGE_USER);
        localStorage.removeItem(STORAGE_PWD);
        checkAuth();
      });
    }

    // Helpers para colores: convertir HEX a RGBA con opacidad y construir un gradiente con opacidad
    function hexToRgba(hex, alpha){
      let h=hex.replace('#','');
      if(h.length===3) h=h.split('').map(c=>c+c).join('');
      const bigint=parseInt(h,16);
      const r=(bigint>>16)&255;
      const g=(bigint>>8)&255;
      const b=bigint&255;
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function linearGradientWithOpacity(color1,color2,alpha){
      return `linear-gradient(180deg, ${hexToRgba(color1,alpha)} 0%, ${hexToRgba(color2,alpha)} 100%)`;
    }
    // Registro/inicio de sesión
    // Genera un hash simple base64 (nuevo formato)
    function hash(str){
      return btoa(str);
    }
    // Calcula un hash SHA-256 en hexadecimal. Usado para compatibilidad con versiones antiguas.
    async function sha256Hex(str){
      const encoder=new TextEncoder();
      const data=encoder.encode(str);
      const digest=await crypto.subtle.digest('SHA-256',data);
      return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    function checkAuth(){
      const user=localStorage.getItem(STORAGE_USER);
      const pwd=localStorage.getItem(STORAGE_PWD);
      // Reiniciar campos y mensaje
      authUser.value='';
      authPass.value='';
      authMsg.style.display='none';
      // Si existe una cuenta guardada, iniciar sesión automáticamente y saltar la puerta
      if(user && pwd){
        authGate.classList.add('hidden');
        appEl.classList.remove('hidden');
        // Preparar la aplicación
        initGame();
        return;
      }
      // De lo contrario, mostrar registro/inicio de sesión según exista usuario
      if(!user||!pwd){
        authTitle.textContent='Crear cuenta';
        authBtn.textContent='Crear cuenta';
      }else{
        authTitle.textContent='Iniciar sesión';
        authBtn.textContent='Iniciar sesión';
      }
      authGate.classList.remove('hidden');
    }
    authBtn.addEventListener('click',async ()=>{
      const u=authUser.value.trim();
      const p=authPass.value.trim();
      if(!u||!p){
        authMsg.textContent='Completa usuario y contraseña';
        authMsg.style.display='block';
        return;
      }
      const storedUser=localStorage.getItem(STORAGE_USER);
      const storedPwd=localStorage.getItem(STORAGE_PWD);
      if(!storedUser){
        // Crear cuenta nueva
        localStorage.setItem(STORAGE_USER,u);
        // Guardar contraseña en nuevo formato base64
        localStorage.setItem(STORAGE_PWD,hash(p));
        authGate.classList.add('hidden');
        appEl.classList.remove('hidden');
        initGame();
      }else{
        // Iniciar sesión: comprobar contraseña en formato base64 o antiguo SHA-256
        const hashed=hash(p);
        let ok=false;
        if(u===storedUser && hashed===storedPwd){
          ok=true;
        }else{
          // Intentar con hash antiguo
          const oldHash=await sha256Hex(p);
          if(u===storedUser && oldHash===storedPwd){
            // Migrar: guardar en nuevo formato para próximas veces
            localStorage.setItem(STORAGE_PWD,hashed);
            ok=true;
          }
        }
        if(ok){
          authGate.classList.add('hidden');
          appEl.classList.remove('hidden');
          initGame();
        }else{
          authMsg.textContent='Credenciales incorrectas';
          authMsg.style.display='block';
        }
      }
    });

    // Juego
    function initGame(){
      // Cargar configuración guardada
      const saved=localStorage.getItem(STORAGE_SETTINGS);
      if(saved){
        try{
          const obj=JSON.parse(saved);
          Object.assign(state.settings,obj);
        }catch(e){}
      }
      applySettingsToUI();
      applyThemeToUI();
      applySoundToUI();
      applyEffectsToUI();
      applyCssVars();
      // Construir tablero
      boardEl.innerHTML='';
      state.board=Array(9).fill('');
      for(let i=0;i<9;i++){
        const cell=document.createElement('div');
        cell.className='cell';
        cell.dataset.index=i;
        cell.addEventListener('click',()=>handleCell(i));
        boardEl.appendChild(cell);
      }
      updateUI();
      maybeAiTurn();
    }

    function handleCell(i){
      if(!state.playing) return;
      if(state.board[i]) return;
      // Reproducir sonido de movimiento si corresponde
      playMoveSound();
      // marcar celda y aplicar animación pop
      state.board[i]=state.turn;
      addPopToCell(i);
      state.lastMove=i;
      updateUI();
      if(checkWinner(state.turn)){
        state.playing=false;
        if(state.turn==='X') state.scores.X++; else state.scores.O++;
        updateScore();
        setTimeout(()=>nextRound(),800);
        playSfx('win');
        // Mostrar animación de victoria con confeti
        showWinAnimation(state.turn);
        return;
      }
      if(state.board.every(v=>v)){
        state.playing=false;
        state.scores.D++;
        updateScore();
        setTimeout(()=>nextRound(),800);
        playSfx('draw');
        // Mostrar animación de empate
        showWinAnimation('draw');
        return;
      }
      // Cambiar turno
      state.turn=state.turn==='X'?'O':'X';
      updateTurnUI();
      maybeAiTurn();
    }

    function checkWinner(player){
      const b=state.board;
      const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      return wins.some(([a,b2,c])=>b[a]===player && b[b2]===player && b[c]===player);
    }
    function nextRound(){
      state.board=Array(9).fill('');
      state.playing=true;
      state.turn='X';
      state.lastMove=null;
      updateUI();
      maybeAiTurn();
    }
    function resetGame(){
      state.scores={X:0,O:0,D:0};
      nextRound();
    }
    // IA simple: mueve aleatoriamente
    function aiMove(){
      const empty=state.board.map((v,i)=>v?null:i).filter(v=>v!==null);
      if(!empty.length) return;
      const idx=empty[Math.floor(Math.random()*empty.length)];
      handleCell(idx);
    }
    function maybeAiTurn(){
      if(!state.playing) return;
      if(state.settings.mode==='pvsp') return;
      const isAiTurn=(state.settings.mode==='pvai' && state.turn==='O') || (state.settings.mode==='aivsa');
      if(isAiTurn){
        setTimeout(()=>{
          aiMove();
          if(state.settings.mode==='aivsa' && state.playing){
            // en autoplay, deja que la IA siga moviendo automáticamente
            maybeAiTurn();
          }
        },state.settings.aiDelay);
      }
    }
    // Actualizar la interfaz
    function updateUI(){
      const cells=boardEl.children;
      for(let i=0;i<9;i++){
        const cell=cells[i];
        cell.textContent=state.board[i];
        cell.classList.remove('markX','markO','win');
        if(state.board[i]==='X') cell.classList.add('markX');
        if(state.board[i]==='O') cell.classList.add('markO');
      }
      updateTurnUI();
    }
    function updateTurnUI(){
      turnMark.textContent=state.turn;
    }
    function updateScore(){
      scoreX.textContent=state.scores.X;
      scoreO.textContent=state.scores.O;
      scoreD.textContent=state.scores.D;
    }
    // Aplicar configuración CSS
    function applyCssVars(){
      const r=document.documentElement.style;
      r.setProperty('--cell-gap',state.settings.cellGap+'px');
      r.setProperty('--cell-radius',state.settings.cellRadius+'px');
      r.setProperty('--cell-size',state.settings.cellSize?state.settings.cellSize+'px':state.settings.cellRadius*4+'px');
      r.setProperty('--mark-scale',state.settings.markScale);
      // Guardar referencias de colores base para paneles y fichas
      const basePanel1 = state.settings.theme.panel;
      const basePanel2 = state.settings.theme.panel2;
      const baseX = state.settings.xColor;
      const baseO = state.settings.oColor;
      // Asignar colores de fondo superiores
      r.setProperty('--bg1', state.settings.theme.bg1);
      r.setProperty('--bg2', state.settings.theme.bg2);
      // Configurar fondo personalizado o degradado base
      if(state.settings.theme.wallpaper){
        // Aplicar la imagen de fondo directamente
        document.body.style.background = `url(${state.settings.theme.wallpaper})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundRepeat = 'no-repeat';
        // Hacer más transparentes las capas de cristal, líneas y paneles para que el wallpaper sea visible
        r.setProperty('--glass','rgba(255,255,255,.12)');
        r.setProperty('--glass2','rgba(255,255,255,.05)');
        r.setProperty('--stroke','rgba(255,255,255,.18)');
        // Calcular colores atenuados mezclando el color base con transparencia. En lugar de usar color-mix,
        // utilizamos la función hexToRgba que convierte un código HEX en RGBA y nos permite ajustar la opacidad.
        // Esto garantiza que el efecto funcione de manera consistente en todos los navegadores.
        const lighten = (col, alpha) => hexToRgba(col, alpha);
        // Atenuar el color de los paneles principales para que el fondo sea claramente visible. Al usar un valor
        // más bajo se logra mayor transparencia: 0.30 deja ver de forma nítida el wallpaper; 0.20 para el panel2.
        r.setProperty('--panel', lighten(basePanel1, 0.30));
        r.setProperty('--panel2', lighten(basePanel2, 0.20));
        // Atenuar las fichas X y O para que no opaquen la imagen de fondo. Se utilizan valores moderados
        // para conservar la legibilidad de las marcas sobre cualquier wallpaper.
        r.setProperty('--x', lighten(baseX, 0.35));
        r.setProperty('--o', lighten(baseO, 0.35));

        // Oscurecer la barra de navegación y los botones de navegación cuando hay fondo para mejorar el contraste.
        // En lugar de derivar del color del tema utilizamos tonos oscuros fijos con distintos niveles de opacidad.
        r.setProperty('--navBg','rgba(0,0,0,.40)');
        r.setProperty('--navBtnBg','rgba(0,0,0,.50)');
        r.setProperty('--navBtnBgActive','rgba(0,0,0,.65)');
      } else {
        // Sin fondo personalizado: degradado base
        const grad = linearGradientWithOpacity(state.settings.theme.bg1, state.settings.theme.bg2, 1);
        document.body.style.background = grad;
        document.body.style.backgroundSize = '';
        document.body.style.backgroundPosition = '';
        document.body.style.backgroundRepeat = '';
        // Restaurar valores base de glass, líneas y paneles
        r.setProperty('--glass','rgba(255,255,255,.16)');
        r.setProperty('--glass2','rgba(255,255,255,.08)');
        r.setProperty('--stroke','rgba(255,255,255,.25)');
        r.setProperty('--panel', basePanel1);
        r.setProperty('--panel2', basePanel2);
        r.setProperty('--x', baseX);
        r.setProperty('--o', baseO);
        // Restablecer colores de barra de navegación y botones basados en los paneles. Utilizamos porcentajes
        // moderados para que armonicen con el tema por defecto.
        const lighten = (col, alpha) => hexToRgba(col, alpha);
        r.setProperty('--navBg', lighten(basePanel1, 0.15));
        r.setProperty('--navBtnBg', lighten(basePanel2, 0.25));
        r.setProperty('--navBtnBgActive', lighten(basePanel2, 0.35));
      }
      r.setProperty('--anim-enabled',state.settings.anim?1:0);
      // Ajustar la velocidad del pulso
      r.setProperty('--pop-speed', (state.settings.animSpeed||0.3) + 's');
      document.body.classList.toggle('anim-off',!state.settings.anim);
      // Aplicar estado del efecto glow
      if(state.settings.effects && state.settings.effects.glow){
        document.body.classList.add('glow-on');
      }else{
        document.body.classList.remove('glow-on');
      }
      // Mostrar u ocultar la capa de ruido en función de la configuración
      if(state.settings.effects && state.settings.effects.noise){
        noiseLayer.style.display='block';
      }else{
        noiseLayer.style.display='none';
      }
    }
    // Ajustes -> cargar valores en formulario
    function applySettingsToUI(){
      modeSelect.value=state.settings.mode;
      aiDelay.value=state.settings.aiDelay;
      animEnabled.checked=state.settings.anim;
      animSpeedInput.value=state.settings.animSpeed;
      gapInput.value=state.settings.cellGap;
      radiusInput.value=state.settings.cellRadius;
      markScaleInput.value=state.settings.markScale;
      colorX.value=state.settings.xColor;
      colorO.value=state.settings.oColor;
    }
    // Tema -> cargar valores
    function applyThemeToUI(){
      themeBg1.value=state.settings.theme.bg1;
      themeBg2.value=state.settings.theme.bg2;
      themePanel.value=state.settings.theme.panel;
      themePanel2.value=state.settings.theme.panel2;
      // Cargar valor de parallax (intensidad del efecto 3D)
      if(themeParallax) themeParallax.value = state.settings.theme.parallax || 0;
      // actualizar json
      updateThemeJson();
      // No se actualiza control de opacidad de fondo porque se eliminó
    }
    function applySoundToUI(){
      soundEnabled.checked=state.settings.sound.enabled;
      soundVolume.value=state.settings.sound.volume;
      if(moveSoundEnabled) moveSoundEnabled.checked = state.settings.sound.moveSoundEnabled;
    }

    // Efectos visuales -> cargar valores
    function applyEffectsToUI(){
      noiseEnabled.checked = state.settings.effects && state.settings.effects.noise;
      glowEnabled.checked = state.settings.effects && state.settings.effects.glow;
      confettiEnabled.checked = state.settings.effects && state.settings.effects.confetti;
    }
    // Guardar configuración
    function saveSettings(){
      localStorage.setItem(STORAGE_SETTINGS,JSON.stringify(state.settings));
    }
    // Sonido simple con Web Audio API
    let audioCtx;
    /*
      Sonido de movimiento (clic). Para evitar problemas de ruta y permitir que el juego
      funcione correctamente en GitHub Pages y otros entornos estáticos, incrustamos el
      archivo MP3 como un Data URI. Esto elimina las peticiones HTTP adicionales y
      garantiza que el sonido esté disponible antes de reproducirse. Si necesitas
      sustituir el sonido por otro, reemplaza el valor de "moveSoundDataUri" por un
      Data URI generado a partir del nuevo archivo MP3 (p. ej. usando base64).

      Nota: El Data URI ha sido generado previamente a partir del archivo
      "mouse-click-sfx-444806.mp3" y puede ser bastante largo. Está colocado como una
      constante para que el navegador lo cargue de inmediato. Se especifica el tipo
      "audio/mp3" explícitamente para que todos los navegadores lo interpreten de forma
      correcta.
    */
    /*
      Sonido de movimiento (clic). Para garantizar que el sonido siempre esté disponible y evitar
      bloqueos al cargar un archivo externo (sobre todo al desplegarse en GitHub Pages),
      incrustamos el archivo MP3 como un Data URI. El valor proviene del archivo
      "moveSoundDataURI.txt" generado previamente. Si deseas sustituir el sonido,
      reemplaza la siguiente cadena por el Data URI correspondiente del nuevo archivo.
    */
    // Ruta del sonido de clic. Se utiliza un archivo mp3 incluido en el mismo repositorio (misma ruta que index.html).
    // Se usa un objeto Audio base y se clonará en cada reproducción para evitar interferencias entre instancias.
    const moveAudioBase = new Audio('mouse-click-sfx-444806.mp3');
    moveAudioBase.preload = 'auto';
    try{ moveAudioBase.load(); }catch(e){}
    function playTone(freq,dur){
      if(!state.settings.sound.enabled) return;
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const osc=audioCtx.createOscillator();
      const gain=audioCtx.createGain();
      osc.type='square';
      osc.frequency.value=freq;
      gain.gain.value=state.settings.sound.volume;
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime+dur);
    }
    // Reproduce un sonido corto (tipo beep) para eventos como victoria o empate. Si
    // se desea personalizar estos sonidos, puede modificarse la frecuencia y duración.
    function playSfx(type){
      if(type==='win') playTone(440,0.3);
      else if(type==='draw') playTone(180,0.2);
      else playTone(300,0.1);
    }

    // Reproduce el sonido de movimiento (clic) si el sonido está habilitado. Encapsulamos
    // la lógica en una función para poder manejar errores y centralizar la configuración.
    function playMoveSound(){
      // Reproduce el sonido de movimiento. Si el audio está deshabilitado, no hace nada.
      if(!state.settings.sound.enabled || !state.settings.sound.moveSoundEnabled) return;
      try{
        // Clonar el elemento base para evitar conflictos con reproducciones en curso.
        const audio = moveAudioBase.cloneNode();
        audio.volume = state.settings.sound.volume;
        audio.currentTime = 0;
        audio.play().catch(()=>{});
      }catch(e){
        // Silenciar cualquier error para que el flujo del juego continúe
      }
    }

    // === Animación de pulsación ===
    // Agrega la clase .pop al elemento y la remueve al finalizar la animación.
    function addPop(el){
      if(!state.settings.anim) return;
      el.classList.add('pop');
      // Definir el manejador fuera para poder eliminarlo posteriormente
      const handler = () => {
        el.classList.remove('pop');
        el.removeEventListener('animationend', handler);
      };
      el.addEventListener('animationend', handler);
    }
    // Añade efecto pop a una celda del tablero usando su índice
    function addPopToCell(idx){
      const el = boardEl.children[idx];
      if(el) addPop(el);
    }
    // Adjunta el efecto pop a botones de navegación y botones principales
    function attachPopToElements(){
      const navButtons=[homeBtn,settingsBtn,themeBtn,soundBtn];
      navButtons.forEach(btn=>{
        btn.addEventListener('click',()=>{addPop(btn);});
      });
      // Botones principales (reiniciar, nueva ronda, reiniciar todo)
      document.querySelectorAll('.btn').forEach(btn=>{
        btn.addEventListener('click',()=>{addPop(btn);});
      });
      // Botones dentro de modales (aplicar, resetear, volver, importar, etc.)
      document.querySelectorAll('.modalCard button').forEach(btn=>{
        btn.addEventListener('click',()=>{addPop(btn);});
      });
    }

    // Colores para los confetis de la animación de victoria
    const confColors=['#ff5e8c','#ffc94d','#5effa1','#6ecbff','#e4ff56'];
    // Muestra una animación de victoria o empate. Crea un overlay con mensaje y confeti y lo elimina tras unos segundos.
    function showWinAnimation(winner){
      const overlay=document.createElement('div');
      overlay.className='winOverlay';
      const msg=document.createElement('div');
      msg.className='message';
      if(winner==='draw'){
        msg.textContent='¡Empate!';
      }else{
        msg.textContent = winner==='X' ? '¡X gana!' : '¡O gana!';
      }
      overlay.appendChild(msg);
      // Añadir confeti solo si está activado en efectos
      if(state.settings.effects && state.settings.effects.confetti){
        for(let i=0;i<30;i++){
          const conf=document.createElement('div');
          conf.className='confetti';
          conf.style.left=(Math.random()*100)+'vw';
          conf.style.backgroundColor=confColors[Math.floor(Math.random()*confColors.length)];
          conf.style.animationDuration=(2+Math.random())+'s';
          overlay.appendChild(conf);
        }
      }
      document.body.appendChild(overlay);
      // Eliminar después de 3 segundos
      setTimeout(()=>{overlay.remove();},3000);
    }
    // Eventos botones de navegación
    function closeAllModals(){
      settingsModal.classList.remove('active');
      themeModal.classList.remove('active');
      soundModal.classList.remove('active');
    }
    homeBtn.addEventListener('click',()=>{closeAllModals();homeBtn.classList.add('active');settingsBtn.classList.remove('active');themeBtn.classList.remove('active');soundBtn.classList.remove('active');});
    settingsBtn.addEventListener('click',()=>{closeAllModals();settingsModal.classList.add('active');settingsBtn.classList.add('active');homeBtn.classList.remove('active');themeBtn.classList.remove('active');soundBtn.classList.remove('active');});
    // Botón de tema ahora abre el modal de personalización (styleModal)
    themeBtn.addEventListener('click',()=>{
      closeAllModals();
      styleModal.classList.add('active');
      themeBtn.classList.add('active');
      homeBtn.classList.remove('active');
      settingsBtn.classList.remove('active');
      soundBtn.classList.remove('active');
    });
    soundBtn.addEventListener('click',()=>{closeAllModals();soundModal.classList.add('active');soundBtn.classList.add('active');homeBtn.classList.remove('active');settingsBtn.classList.remove('active');themeBtn.classList.remove('active');});
    // Cerrar con botón ✕
    document.getElementById('closeSettings').onclick=()=>{settingsModal.classList.remove('active');settingsBtn.classList.remove('active');homeBtn.classList.add('active');};
    document.getElementById('closeTheme').onclick=()=>{themeModal.classList.remove('active');themeBtn.classList.remove('active');homeBtn.classList.add('active');};
    document.getElementById('closeSound').onclick=()=>{soundModal.classList.remove('active');soundBtn.classList.remove('active');homeBtn.classList.add('active');};
    // Botones principales
    document.getElementById('btnReset').onclick=()=>{nextRound();};
    document.getElementById('btnNext').onclick=()=>{nextRound();};
    document.getElementById('btnResetAll').onclick=()=>{resetGame();};
    // Aplicar y restaurar ajustes
    applySettingsBtn.addEventListener('click',()=>{
      state.settings.mode=modeSelect.value;
      state.settings.aiDelay=parseInt(aiDelay.value)||600;
      state.settings.anim=animEnabled.checked;
      state.settings.animSpeed=parseFloat(animSpeedInput.value)||0.3;
      state.settings.cellGap=parseInt(gapInput.value)||18;
      state.settings.cellRadius=parseInt(radiusInput.value)||18;
      state.settings.markScale=parseFloat(markScaleInput.value)||1;
      state.settings.xColor=colorX.value;
      state.settings.oColor=colorO.value;
      applyCssVars();
      saveSettings();
      nextRound();

      // Cerrar modal y volver a la pantalla principal
      settingsModal.classList.remove('active');
      settingsBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    resetSettingsBtn.addEventListener('click',()=>{
      state.settings={
        ...state.settings,
        mode:'pvsp',
        aiDelay:600,
        anim:true,
        animSpeed:0.3,
        cellGap:18,
        cellRadius:18,
        markScale:1,
        xColor:'#3a3f95',
        oColor:'#ffffff'
      };
      applySettingsToUI();
      applyCssVars();
      saveSettings();
      nextRound();
      // Cerrar modal y volver a la pantalla principal
      settingsModal.classList.remove('active');
      settingsBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    // Tema: aplicar y resetear
    applyThemeBtn.addEventListener('click',()=>{
      state.settings.theme.bg1=themeBg1.value;
      state.settings.theme.bg2=themeBg2.value;
      state.settings.theme.panel=themePanel.value;
      state.settings.theme.panel2=themePanel2.value;
      // Guardar intensidad de parallax
      if(themeParallax) state.settings.theme.parallax = parseFloat(themeParallax.value || 0);
      applyCssVars();
      applyThemeToUI();
      saveSettings();

      // Cerrar modal y volver a la pantalla principal
      themeModal.classList.remove('active');
      themeBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });

    // Aplicar tema y volver en un solo paso
    if(applyThemeAndReturnBtn){
      applyThemeAndReturnBtn.addEventListener('click',()=>{
        // Copiar lógica de aplicar tema
        state.settings.theme.bg1=themeBg1.value;
        state.settings.theme.bg2=themeBg2.value;
        state.settings.theme.panel=themePanel.value;
        state.settings.theme.panel2=themePanel2.value;
        // Guardar intensidad de parallax al aplicar y volver
        if(themeParallax) state.settings.theme.parallax = parseFloat(themeParallax.value || 0);
        applyCssVars();
        applyThemeToUI();
        saveSettings();
        // Cerrar modal y volver a pantalla principal
        themeModal.classList.remove('active');
        themeBtn.classList.remove('active');
        homeBtn.classList.add('active');
      });
    }
    resetThemeBtn.addEventListener('click',()=>{
      state.settings.theme={
        bg1:'#6c2bd9',
        bg2:'#b02bd9',
        panel:'#ff56e0',
        panel2:'#ff7cf0',
        wallpaper:'',
        parallax:0
      };
      applyCssVars();
      applyThemeToUI();
      saveSettings();
      // Cerrar modal y volver a la pantalla principal
      themeModal.classList.remove('active');
      themeBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    // Tema JSON helper
    function updateThemeJson(){
      const json={name:'Mi tema',version:1,vars:{
        '--bg1':state.settings.theme.bg1,
        '--bg2':state.settings.theme.bg2,
        '--panel':state.settings.theme.panel,
        '--panel2':state.settings.theme.panel2,
        '--x':state.settings.xColor,
        '--o':state.settings.oColor,
        '--wallpaper':state.settings.theme.wallpaper||'',
        '--parallax':state.settings.theme.parallax
      }};
      themeJson.value=JSON.stringify(json,null,2);
    }
    applyThemeJsonBtn.addEventListener('click',()=>{
      try{
        const obj=JSON.parse(themeJson.value);
        const vars=obj.vars||obj;
        if(vars['--bg1']) state.settings.theme.bg1=vars['--bg1'];
        if(vars['--bg2']) state.settings.theme.bg2=vars['--bg2'];
        if(vars['--panel']) state.settings.theme.panel=vars['--panel'];
        if(vars['--panel2']) state.settings.theme.panel2=vars['--panel2'];
        if(vars['--x']) state.settings.xColor=vars['--x'];
        if(vars['--o']) state.settings.oColor=vars['--o'];
        if(vars['--wallpaper']!==undefined){
          // Asignar wallpaper; si es cadena vacía se elimina
          state.settings.theme.wallpaper = vars['--wallpaper'] || '';
        }
        if(vars['--parallax']!==undefined){
          state.settings.theme.parallax = parseFloat(vars['--parallax']) || 0;
        }
        // Se ignora la opacidad de fondo en la importación de temas
        applyCssVars();
        applySettingsToUI();
        applyThemeToUI();
        saveSettings();

        // Cerrar modal y volver a la pantalla principal
        themeModal.classList.remove('active');
        themeBtn.classList.remove('active');
        homeBtn.classList.add('active');
      }catch(e){alert('JSON inválido');}
    });
    copyThemeJsonBtn.addEventListener('click',()=>{
      navigator.clipboard.writeText(themeJson.value).then(()=>{alert('Tema copiado en el portapapeles');});
    });
    exportThemeJsonBtn.addEventListener('click',()=>{
      const blob=new Blob([themeJson.value],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='triki-theme.json';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    });
    importThemeJsonBtn.addEventListener('click',()=>{importThemeFile.click();});
    importThemeFile.addEventListener('change',e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=function(ev){themeJson.value=ev.target.result;applyThemeJsonBtn.click();};
      reader.readAsText(file);
    });

    // Fondo personalizado
    selectWallpaper.addEventListener('click',()=>{
      wallpaperInput.click();
    });
    wallpaperInput.addEventListener('change',e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=function(ev){
        state.settings.theme.wallpaper=ev.target.result;
        applyCssVars();
        // Actualizar los controles de tema para reflejar la imagen cargada
        applyThemeToUI();
        updateThemeJson();
        saveSettings();
      };
      reader.readAsDataURL(file);
    });
    clearWallpaper.addEventListener('click',()=>{
      state.settings.theme.wallpaper='';
      applyCssVars();
      updateThemeJson();
      saveSettings();
    });

    // Navegación: botones de volver en modales
    backSettings.addEventListener('click',()=>{
      settingsModal.classList.remove('active');
      settingsBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    backTheme.addEventListener('click',()=>{
      themeModal.classList.remove('active');
      themeBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    backSound.addEventListener('click',()=>{
      soundModal.classList.remove('active');
      soundBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    // Sonido
    applySoundBtn.addEventListener('click',()=>{
      state.settings.sound.enabled=soundEnabled.checked;
      state.settings.sound.volume=parseFloat(soundVolume.value)||0.2;
      state.settings.sound.moveSoundEnabled = moveSoundEnabled.checked;
      saveSettings();

      // Cerrar modal y volver a la pantalla principal
      soundModal.classList.remove('active');
      soundBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    // Guardar tema/json al cambiar colores
    themeBg1.addEventListener('change',updateThemeJson);
    themeBg2.addEventListener('change',updateThemeJson);
    themePanel.addEventListener('change',updateThemeJson);
    themePanel2.addEventListener('change',updateThemeJson);
    colorX.addEventListener('change',()=>{state.settings.xColor=colorX.value;applyCssVars();updateThemeJson();saveSettings();});
    colorO.addEventListener('change',()=>{state.settings.oColor=colorO.value;applyCssVars();updateThemeJson();saveSettings();});
    // Animar efecto parallax al mover el ratón si hay fondo
    document.addEventListener('mousemove',(e)=>{
      const p = state.settings.theme.parallax || 0;
      if(state.settings.theme.wallpaper && p > 0){
        const relX = (e.clientX / window.innerWidth - 0.5) * p;
        const relY = (e.clientY / window.innerHeight - 0.5) * p;
        document.body.style.backgroundPosition = `calc(50% + ${relX}px) calc(50% + ${relY}px)`;
      }else{
        // Restablecer posición centrada cuando no hay parallax
        document.body.style.backgroundPosition = 'center';
      }
    });
    // Actualizar JSON cuando cambia el parallax
    if(themeParallax) themeParallax.addEventListener('input',updateThemeJson);
    // Iniciar autenticación cuando cargue la página
    document.addEventListener('DOMContentLoaded',()=>{
      checkAuth();
      // Adjuntar animación de pulsación a elementos interactivos una vez cargado el DOM
      attachPopToElements();

      // Personalización: manejar clics en los ítems de la pantalla de estilo
      document.querySelectorAll('.styleItem').forEach(item=>{
        item.addEventListener('click',()=>{
          const target=item.dataset.target;
          // Cerrar la pantalla de personalización
          styleModal.classList.remove('active');
          // Reset nav active
          themeBtn.classList.remove('active');
          settingsBtn.classList.remove('active');
          soundBtn.classList.remove('active');
          homeBtn.classList.remove('active');
          // Abrir el modal correspondiente
          if(target==='theme'){
            themeModal.classList.add('active');
            themeBtn.classList.add('active');
          }else if(target==='icons'){
            settingsModal.classList.add('active');
            settingsBtn.classList.add('active');
          }else if(target==='board'){
            settingsModal.classList.add('active');
            settingsBtn.classList.add('active');
          }else if(target==='wallpaper'){
            themeModal.classList.add('active');
            themeBtn.classList.add('active');
          }else if(target==='effects'){
            effectsModal.classList.add('active');
            themeBtn.classList.add('active');
          }
        });
      });
      // Botón para cerrar la pantalla de personalización
      if(closeStyle) closeStyle.addEventListener('click',()=>{
        styleModal.classList.remove('active');
        // Restablecer navegación
        themeBtn.classList.remove('active');
        homeBtn.classList.add('active');
      });
      // Cerrar efectos visuales
      if(closeEffects) closeEffects.addEventListener('click',()=>{
        effectsModal.classList.remove('active');
        themeBtn.classList.remove('active');
        homeBtn.classList.add('active');
      });
      if(backEffects) backEffects.addEventListener('click',()=>{
        effectsModal.classList.remove('active');
        themeBtn.classList.remove('active');
        homeBtn.classList.add('active');
      });
      // Aplicar efectos
      if(applyEffectsBtn) applyEffectsBtn.addEventListener('click',()=>{
        state.settings.effects={
          noise: noiseEnabled.checked,
          glow: glowEnabled.checked,
          confetti: confettiEnabled.checked
        };
        applyCssVars();
        saveSettings();
        effectsModal.classList.remove('active');
        themeBtn.classList.remove('active');
        homeBtn.classList.add('active');
      });
    });
  </script>
</body>
</html>