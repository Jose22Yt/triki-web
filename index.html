<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TRIKI ‚Äî Tres en Raya</title>
<style>
:root{
  --bg1:#6c2bd9; --bg2:#b02bd9; --panel:#ff56e0; --panel2:#ff7cf0;
  --glass:rgba(255,255,255,.16); --stroke:rgba(255,255,255,.25);
  --text:#fff; --muted:rgba(255,255,255,.78);
  --x:#3a3f95; --o:#fff;
  --navBg:rgba(255,255,255,.32); --btnBg:rgba(255,255,255,.10); --btnBgOn:rgba(255,255,255,.18);
  --navH:78px;
}
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; color:var(--text);
  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  display:flex; justify-content:center;
  padding:18px 14px calc(var(--navH) + 14px + env(safe-area-inset-bottom,0px));
}
.app{width:min(520px,100%)}
h1{margin:8px 0 0; font-size:54px; font-weight:950; letter-spacing:.5px; line-height:.95}
.sub{margin-top:10px; font-size:24px; color:var(--muted); font-weight:600}
.card{
  margin-top:22px; border-radius:28px;
  background:linear-gradient(180deg,color-mix(in srgb,var(--panel2) 86%, white 14%),var(--panel));
  padding:18px; border:2px solid rgba(255,255,255,.14);
  box-shadow:0 18px 60px rgba(0,0,0,.28);
}
.pillWrap{display:flex; justify-content:center; margin:6px 0 10px}
.pill{
  display:inline-flex; gap:12px; align-items:center;
  padding:12px 26px; border-radius:999px;
  background:var(--glass); border:2px solid var(--stroke);
  font-weight:950; letter-spacing:1px; text-transform:uppercase;
}
.pill .mark{
  min-width:34px; height:34px; display:grid; place-items:center;
  border-radius:999px; background:rgba(255,255,255,.12);
  border:2px solid rgba(255,255,255,.22); font-size:22px; font-weight:1000;
}
.shell{
  border-radius:30px; padding:18px;
  background:rgba(255,255,255,.14); border:2px solid rgba(255,255,255,.20);
}
.board{
  width:100%; aspect-ratio:1/1;
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:16px; padding:10px;
  border-radius:26px; background:rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.18);
}
.cell{
  border-radius:18px; min-height:78px;
  background:rgba(255,255,255,.16); border:2px solid rgba(255,255,255,.22);
  display:grid; place-items:center; cursor:pointer; user-select:none;
  font-size:clamp(34px,8vw,54px); font-weight:1000;
  transition:transform .08s ease, background .18s ease;
  box-shadow:0 18px 34px rgba(0,0,0,.10);
}
.cell:hover{transform:translateY(-1px); background:rgba(255,255,255,.20)}
.cell:active{transform:scale(.99)}
.cell.disabled{cursor:not-allowed; opacity:.78}
.cell.win{background:rgba(255,255,255,.28); border-color:rgba(255,255,255,.35)}
.markX{color:var(--x)} .markO{color:var(--o)}
.buttons{display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; margin-top:16px}
.btn{
  border-radius:18px; padding:18px 12px;
  border:2px solid rgba(255,255,255,.22);
  background:rgba(255,255,255,.10); color:var(--text);
  font-weight:950; font-size:28px; cursor:pointer;
  box-shadow:0 16px 34px rgba(0,0,0,.14);
}
.btn.small{font-size:22px}
.score{margin-top:16px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
.sCard{
  border-radius:18px; padding:14px 12px; text-align:center;
  background:rgba(255,255,255,.10); border:2px solid rgba(255,255,255,.18);
}
.sLabel{font-size:16px; letter-spacing:1px; font-weight:900; opacity:.92}
.sVal{margin-top:4px; font-size:28px; font-weight:1000}

/* Bottom nav */
.nav{
  position:fixed; left:0; right:0; bottom:0; z-index:50;
  padding:14px 16px calc(14px + env(safe-area-inset-bottom,0px));
  background:var(--navBg); backdrop-filter:blur(12px);
  border-top:1px solid rgba(255,255,255,.28);
  display:flex; justify-content:center;
}
.navInner{width:min(520px,100%); display:flex; justify-content:space-between; gap:10px; align-items:center}
.navBtn{
  width:64px; height:52px; border-radius:18px;
  border:2px solid rgba(255,255,255,.18);
  background:var(--btnBg); color:var(--text);
  display:grid; place-items:center; cursor:pointer;
}
.navBtn.on{background:var(--btnBgOn)}
.navBtn svg{width:26px; height:26px; opacity:.78}

/* Toast */
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:calc(var(--navH) + 8px + env(safe-area-inset-bottom,0px));
  background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.25);
  padding:10px 14px; border-radius:999px; display:none; z-index:60;
  backdrop-filter:blur(10px); font-weight:850; max-width:calc(100% - 28px);
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.toast.show{display:block}

/* Modal */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.30); display:none; z-index:70}
.backdrop.show{display:block}
.modal{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:calc(14px + var(--navH) + env(safe-area-inset-bottom,0px));
  width:min(520px,calc(100% - 24px));
  border-radius:26px; padding:14px;
  background:rgba(255,255,255,.22); border:1px solid rgba(255,255,255,.25);
  backdrop-filter:blur(16px); box-shadow:0 22px 70px rgba(0,0,0,.25);
  display:none; z-index:80;
}
.modal.show{display:block}
.mHead{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 6px 10px}
.mHead h2{margin:0; font-size:18px; font-weight:950; letter-spacing:.4px}
.close{width:42px; height:42px; border-radius:14px; cursor:pointer;
  border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.12); color:var(--text)}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.field{border-radius:18px; padding:12px; border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.10)}
.field label{display:block; font-size:12px; font-weight:900; letter-spacing:.6px; opacity:.9}
select,input,textarea{
  width:100%; margin-top:8px; padding:12px; border-radius:14px;
  border:1px solid rgba(255,255,255,.24); background:rgba(255,255,255,.12);
  color:var(--text); outline:none; font-weight:850;
}
input[type="color"]{height:44px; padding:6px}
textarea{min-height:140px; resize:vertical; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-weight:650}
.row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.pillBtn{flex:1; min-width:140px; padding:12px; border-radius:18px; cursor:pointer;
  border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.12); color:var(--text); font-weight:950}
.chips{display:flex; gap:10px; flex-wrap:wrap; padding:6px}
.chip{padding:10px 12px; border-radius:999px; font-size:12px; font-weight:950; cursor:pointer;
  border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.10)}
.hint{margin:8px 6px 0; font-size:12px; opacity:.92; line-height:1.35}
@media (max-width:390px){
  h1{font-size:46px} .sub{font-size:21px}
  .btn{font-size:22px} .btn.small{font-size:18px}
  .grid2{grid-template-columns:1fr} .board{gap:14px}
}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <h1>TRIKI</h1>
    <div class="sub">Tres en Raya</div>
  </div>

  <div class="card">
    <div class="pillWrap">
      <div class="pill"><span>TURNO:</span><span class="mark" id="turnMark">X</span></div>
    </div>

    <div class="shell"><div class="board" id="board" aria-label="Tablero"></div></div>

    <div class="buttons">
      <button class="btn" id="btnReset">Reiniciar</button>
      <button class="btn" id="btnNew">Nueva<br/>Ronda</button>
      <button class="btn small" id="btnResetAll">Reiniciar<br/>Todo</button>
    </div>

    <div class="score">
      <div class="sCard"><div class="sLabel">X</div><div class="sVal" id="sx">0</div></div>
      <div class="sCard"><div class="sLabel">EMPATES</div><div class="sVal" id="sd">0</div></div>
      <div class="sCard"><div class="sLabel">O</div><div class="sVal" id="so">0</div></div>
    </div>
  </div>
</div>

<!-- Bottom nav -->
<div class="nav" aria-label="Barra inferior">
  <div class="navInner">
    <button class="navBtn" id="navStyle" title="Estilo" aria-label="Estilo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path>
        <path d="M2 12h2"></path><path d="M20 12h2"></path>
      </svg>
    </button>
    <button class="navBtn" id="navTheme" title="Tema" aria-label="Tema">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z"></path><path d="M12 18h.01"></path>
      </svg>
    </button>
    <button class="navBtn" id="navGame" title="Juego" aria-label="Juego">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M6 12h4"></path><path d="M8 10v4"></path><path d="M15 11h.01"></path><path d="M18 13h.01"></path>
        <path d="M5 7h14a3 3 0 0 1 3 3v4a3 3 0 0 1-3 3h-1l-2 2h-2l-2-2H12l-2 2H8l-2-2H5a3 3 0 0 1-3-3v-4a3 3 0 0 1 3-3Z"></path>
      </svg>
    </button>
    <button class="navBtn" id="navSound" title="Sonido" aria-label="Sonido">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18V5l12-2v13"></path><circle cx="7" cy="18" r="2"></circle><circle cx="19" cy="16" r="2"></circle>
      </svg>
    </button>
    <button class="navBtn" id="navSettings" title="Configuraci√≥n" aria-label="Configuraci√≥n">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"></path>
        <path d="M19.4 15a1.8 1.8 0 0 0 .36 1.98l.06.06a2.2 2.2 0 0 1-1.56 3.76 2.2 2.2 0 0 1-1.56-.64l-.06-.06a1.8 1.8 0 0 0-1.98-.36 1.8 1.8 0 0 0-1.1 1.64V22a2.2 2.2 0 0 1-4.4 0v-.08A1.8 1.8 0 0 0 7 20.28a1.8 1.8 0 0 0-1.98.36l-.06.06A2.2 2.2 0 1 1 2.4 17.1l.06-.06A1.8 1.8 0 0 0 2.82 15a1.8 1.8 0 0 0-1.64-1.1H1a2.2 2.2 0 0 1 0-4.4h.08A1.8 1.8 0 0 0 2.72 7a1.8 1.8 0 0 0-.36-1.98l-.06-.06A2.2 2.2 0 0 1 3.86 1.2c.56 0 1.14.22 1.56.64l.06.06A1.8 1.8 0 0 0 7 2.22 1.8 1.8 0 0 0 8.1 0.58V0.5a2.2 2.2 0 0 1 4.4 0v.08A1.8 1.8 0 0 0 13.7 2.22a1.8 1.8 0 0 0 1.98-.36l.06-.06c.42-.42 1-.64 1.56-.64a2.2 2.2 0 0 1 1.56 3.76l-.06.06A1.8 1.8 0 0 0 19.4 9c.9.22 1.56 1.02 1.56 1.96v.08a2.2 2.2 0 0 1-1.56 2.12Z"></path>
      </svg>
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="backdrop" id="backdrop"></div>

<!-- Settings modal -->
<div class="modal" id="mSettings" aria-label="Configuraci√≥n">
  <div class="mHead"><h2>Configuraci√≥n</h2><button class="close" data-close>‚úï</button></div>
  <div class="grid2">
    <div class="field">
      <label>Modo</label>
      <select id="mode">
        <option value="pvp">2 Jugadores (local)</option>
        <option value="ai">Jugador vs IA</option>
        <option value="aivai">IA vs IA (autoplay)</option>
      </select>
    </div>
    <div class="field" id="fHuman">
      <label>Humano juega con</label>
      <select id="human"><option value="X">X</option><option value="O">O</option></select>
    </div>
    <div class="field">
      <label>Dificultad IA</label>
      <select id="diff"><option value="easy">F√°cil</option><option value="normal">Normal</option><option value="hard">Dif√≠cil</option></select>
    </div>
    <div class="field">
      <label>Tiempo pensar (ms)</label>
      <input id="think" type="number" min="0" max="2000" step="50" value="250"/>
    </div>
  </div>
  <div class="row">
    <button class="pillBtn" id="applySettings">Aplicar</button>
    <button class="pillBtn" id="resetSettings">Restaurar</button>
  </div>
  <div class="hint">En <b>Dif√≠cil</b> la IA juega perfecto (minimax).</div>
</div>

<!-- Theme modal -->
<div class="modal" id="mTheme" aria-label="Tema">
  <div class="mHead"><h2>Tema</h2><button class="close" data-close>‚úï</button></div>
  <div class="chips" id="presets"></div>
  <div class="grid2">
    <div class="field"><label>Fondo arriba</label><input id="bg1" type="color"/></div>
    <div class="field"><label>Fondo abajo</label><input id="bg2" type="color"/></div>
    <div class="field"><label>Panel</label><input id="panel" type="color"/></div>
    <div class="field"><label>Panel 2</label><input id="panel2" type="color"/></div>
    <div class="field"><label>Color X</label><input id="cx" type="color"/></div>
    <div class="field"><label>Color O</label><input id="co" type="color"/></div>
  </div>
  <div class="row">
    <button class="pillBtn" id="saveTheme">Guardar</button>
    <button class="pillBtn" id="resetTheme">Restaurar</button>
  </div>
  <div class="field" style="margin-top:12px">
    <label>üéõÔ∏è Tema en JSON (import/export)</label>
    <textarea id="themeJson" spellcheck="false"></textarea>
    <div class="row">
      <button class="pillBtn" id="applyJson">Aplicar JSON</button>
      <button class="pillBtn" id="copyJson">Copiar JSON</button>
    </div>
    <div class="row">
      <button class="pillBtn" id="exportJson">Exportar .json</button>
      <button class="pillBtn" id="importJson">Importar .json</button>
    </div>
    <div class="hint">Formato: <code>{"name":"Mi tema","version":1,"vars":{"--bg1":"#..."}}</code> o plano <code>{"--bg1":"#..."}</code></div>
    <input id="themeFile" type="file" accept="application/json" style="display:none"/>
  </div>
</div>

<!-- Sound modal -->
<div class="modal" id="mSound" aria-label="Sonido">
  <div class="mHead"><h2>Sonido</h2><button class="close" data-close>‚úï</button></div>
  <div class="field">
    <label>Audio</label>
    <select id="sound"><option value="on">Activado</option><option value="off">Desactivado</option></select>
  </div>
  <div class="row"><button class="pillBtn" id="applySound">Aplicar</button></div>
  <div class="hint">En iPhone a veces necesitas tocar la pantalla primero para habilitar audio.</div>
</div>

<script>
const LINES=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
const DEFAULT_SETTINGS={mode:'pvp',human:'X',diff:'normal',thinkMs:250,sound:'off'};
const DEFAULT_THEME={'--bg1':'#6c2bd9','--bg2':'#b02bd9','--panel':'#ff56e0','--panel2':'#ff7cf0','--x':'#3a3f95','--o':'#ffffff'};
const PRESETS=[
  {name:'Pink', vars:{...DEFAULT_THEME}},
  {name:'Ocean',vars:{'--bg1':'#1b5bd9','--bg2':'#2bd9b2','--panel':'#49e9ff','--panel2':'#7bfff0','--x':'#0b2b66','--o':'#ffffff'}},
  {name:'Night',vars:{'--bg1':'#28175c','--bg2':'#5c1771','--panel':'#7d2cff','--panel2':'#b65bff','--x':'#f5c2ff','--o':'#ffffff'}},
];

const $=s=>document.querySelector(s);
const boardEl=$('#board'), turnEl=$('#turnMark'), toastEl=$('#toast');
const sx=$('#sx'), so=$('#so'), sd=$('#sd');
const backdrop=$('#backdrop');
const modals={settings:$('#mSettings'), theme:$('#mTheme'), sound:$('#mSound')};

function load(key, fallback){ try{const v=localStorage.getItem(key); return v?JSON.parse(v):fallback;}catch{return fallback;} }
function save(key, obj){ try{localStorage.setItem(key, JSON.stringify(obj));}catch{} }

let settings={...DEFAULT_SETTINGS, ...load('triki-settings', {})};
let themeVars={...DEFAULT_THEME, ...load('triki-theme', {})};

const state={board:Array(9).fill(null), turn:'X', locked:false, starter:'X', scores:load('triki-scores',{X:0,O:0,D:0})};

function toast(msg){
  toastEl.textContent=msg; toastEl.classList.add('show');
  clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.classList.remove('show'),1600);
}

function applyTheme(vars){
  for(const [k,v] of Object.entries(vars)) document.documentElement.style.setProperty(k, v);
}
function syncThemeUI(){
  $('#bg1').value=themeVars['--bg1']; $('#bg2').value=themeVars['--bg2'];
  $('#panel').value=themeVars['--panel']; $('#panel2').value=themeVars['--panel2'];
  $('#cx').value=themeVars['--x']; $('#co').value=themeVars['--o'];
  refreshThemeJson();
}
function themeExportObj(name='Triki Theme'){
  return {name, version:1, createdAt:new Date().toISOString(), vars:{...themeVars}};
}
function refreshThemeJson(){ $('#themeJson').value = JSON.stringify(themeExportObj(), null, 2); }

function openModal(which){
  backdrop.classList.add('show');
  Object.values(modals).forEach(m=>m.classList.remove('show'));
  modals[which].classList.add('show');
}
function closeModal(){
  backdrop.classList.remove('show');
  Object.values(modals).forEach(m=>m.classList.remove('show'));
}
backdrop.addEventListener('click', closeModal);
document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal));

function winner(board){
  for(const [a,b,c] of LINES) if(board[a] && board[a]===board[b] && board[a]===board[c]) return {w:board[a], line:[a,b,c]};
  if(board.every(Boolean)) return {w:'D', line:null};
  return null;
}
const opp=m=>m==='X'?'O':'X';
const legal=b=>b.map((v,i)=>v?null:i).filter(v=>v!==null);

function isAITurn(){
  if(settings.mode==='pvp') return false;
  if(settings.mode==='aivai') return true;
  return state.turn !== settings.human;
}
function isHumanTurn(){
  if(settings.mode==='pvp') return true;
  if(settings.mode==='aivai') return false;
  return state.turn === settings.human;
}

function render(){
  boardEl.innerHTML='';
  const w=winner(state.board);
  const winSet=new Set(w&&w.line?w.line:[]);
  for(let i=0;i<9;i++){
    const cell=document.createElement('div');
    cell.className='cell';
    if(winSet.has(i)) cell.classList.add('win');
    const v=state.board[i];
    if(v){
      cell.textContent=v; cell.classList.add('disabled'); cell.classList.add(v==='X'?'markX':'markO');
    } else {
      if(state.locked || (!isHumanTurn() && settings.mode!=='pvp')) cell.classList.add('disabled');
      cell.addEventListener('click', ()=>play(i));
    }
    boardEl.appendChild(cell);
  }
  turnEl.textContent=state.turn;
  turnEl.style.color = state.turn==='X' ? 'var(--x)' : 'var(--o)';
  sx.textContent=String(state.scores.X); so.textContent=String(state.scores.O); sd.textContent=String(state.scores.D);
}

function endRound(w){
  state.locked=true;
  if(w==='D'){ state.scores.D++; toast('Empate ü§ù'); if(settings.sound==='on') beep(240,.08); }
  else { state.scores[w]++; toast(`Gana ${w} üèÜ`); if(settings.sound==='on') beep(w==='X'?320:420,.10); }
  save('triki-scores', state.scores);
  render();
  if(settings.mode==='aivai') setTimeout(()=>newRound(true), 650);
}

function play(i){
  if(state.locked || state.board[i]) return;
  if(!isHumanTurn() && settings.mode!=='pvp') return;

  state.board[i]=state.turn;
  if(settings.sound==='on') beep(520,.06);

  const res=winner(state.board);
  if(res) endRound(res.w);
  else { state.turn=opp(state.turn); render(); scheduleAI(); }
}

function resetRound(keepTurn=true){
  state.board=Array(9).fill(null);
  state.locked=false;
  if(!keepTurn) state.turn=state.starter;
  render(); scheduleAI();
}
function newRound(auto=false){
  state.starter=opp(state.starter);
  state.turn=state.starter;
  state.board=Array(9).fill(null);
  state.locked=false;
  render(); if(!auto) toast('Nueva ronda'); scheduleAI();
}
function resetAll(){
  state.scores={X:0,O:0,D:0}; save('triki-scores', state.scores);
  state.starter='X'; state.turn='X';
  state.board=Array(9).fill(null); state.locked=false;
  render(); toast('Reiniciado todo'); scheduleAI();
}

$('#btnReset').addEventListener('click', ()=>{ resetRound(true); toast('Reiniciado'); });
$('#btnNew').addEventListener('click', ()=>newRound(false));
$('#btnResetAll').addEventListener('click', resetAll);

// AI (easy random, normal depth 4, hard depth 9)
function scoreTerminal(res, me){
  if(!res) return null;
  if(res.w==='D') return 0;
  return res.w===me ? 10 : -10;
}
function minimax(board, turn, me, depth){
  const res=winner(board);
  const t=scoreTerminal(res, me);
  if(t!==null) return t;
  if(depth<=0) return 0;

  const moves=legal(board);
  const max = (turn===me);
  let best = max ? -Infinity : Infinity;
  for(const i of moves){
    const nb=board.slice(); nb[i]=turn;
    const val=minimax(nb, opp(turn), me, depth-1);
    best = max ? Math.max(best,val) : Math.min(best,val);
  }
  return best;
}
function pickAIMove(){
  const me=state.turn, moves=legal(state.board);
  if(!moves.length) return null;
  if(settings.diff==='easy') return moves[Math.floor(Math.random()*moves.length)];

  const depth = settings.diff==='hard' ? 9 : 4;
  let best=-Infinity, bestMoves=[];
  for(const i of moves){
    const nb=state.board.slice(); nb[i]=me;
    const s=minimax(nb, opp(me), me, depth);
    if(s>best){ best=s; bestMoves=[i]; }
    else if(s===best){ bestMoves.push(i); }
  }
  if(settings.diff==='normal' && bestMoves.length>1) return bestMoves[Math.floor(Math.random()*bestMoves.length)];
  return bestMoves[0];
}
function clamp(n,a,b){ n=Number.isFinite(n)?n:a; return Math.max(a,Math.min(b,n)); }
function scheduleAI(){
  clearTimeout(scheduleAI._t);
  if(state.locked || !isAITurn()) return;
  scheduleAI._t=setTimeout(()=>{
    if(state.locked || !isAITurn()) return;
    const i=pickAIMove();
    if(i===null || state.board[i]) return;
    state.board[i]=state.turn;
    if(settings.sound==='on') beep(420,.06);
    const res=winner(state.board);
    if(res) endRound(res.w);
    else { state.turn=opp(state.turn); render(); scheduleAI(); }
  }, clamp(Number(settings.thinkMs||0),0,2000));
}

// tiny beep
let audioCtx=null;
function beep(freq=440, sec=.06){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.value=freq;
    o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.08,audioCtx.currentTime+.01);
    g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+sec);
    o.start(); o.stop(audioCtx.currentTime+sec+.02);
  }catch{}
}

// Settings modal wiring
function syncSettingsUI(){
  $('#mode').value=settings.mode;
  $('#human').value=settings.human;
  $('#diff').value=settings.diff;
  $('#think').value=String(settings.thinkMs);
  $('#sound').value=settings.sound;
  $('#fHuman').style.display = (settings.mode==='ai') ? 'block' : 'none';
}
$('#mode').addEventListener('change', ()=>$('#fHuman').style.display = ($('#mode').value==='ai') ? 'block':'none');
$('#applySettings').addEventListener('click', ()=>{
  settings.mode=$('#mode').value;
  settings.human=$('#human').value;
  settings.diff=$('#diff').value;
  settings.thinkMs=clamp(Number($('#think').value||0),0,2000);
  save('triki-settings', settings);
  syncSettingsUI(); closeModal(); toast('Configuraci√≥n aplicada'); scheduleAI();
});
$('#resetSettings').addEventListener('click', ()=>{
  settings={...DEFAULT_SETTINGS}; save('triki-settings', settings);
  syncSettingsUI(); toast('Configuraci√≥n restaurada'); scheduleAI();
});

// Theme modal wiring
function setTheme(next, merge=true){
  themeVars = merge ? {...themeVars, ...next} : {...DEFAULT_THEME, ...next};
  applyTheme(themeVars); save('triki-theme', themeVars);
  syncThemeUI();
}
PRESETS.forEach(p=>{
  const el=document.createElement('div');
  el.className='chip'; el.textContent=p.name;
  el.addEventListener('click', ()=>{ setTheme(p.vars, false); toast(`Tema: ${p.name}`); });
  $('#presets').appendChild(el);
});
['bg1','bg2','panel','panel2','cx','co'].forEach(id=>{
  $('#'+id).addEventListener('input', ()=>{
    setTheme({
      '--bg1':$('#bg1').value,'--bg2':$('#bg2').value,'--panel':$('#panel').value,'--panel2':$('#panel2').value,
      '--x':$('#cx').value,'--o':$('#co').value
    }, true);
  });
});
$('#saveTheme').addEventListener('click', ()=>{ save('triki-theme', themeVars); refreshThemeJson(); toast('Tema guardado'); });
$('#resetTheme').addEventListener('click', ()=>{ setTheme(DEFAULT_THEME, false); toast('Tema restaurado'); });

// JSON import/export
function normalizeTheme(obj){
  if(!obj || typeof obj!=='object') throw new Error('JSON debe ser un objeto');
  const vars = (obj.vars && typeof obj.vars==='object') ? obj.vars : obj;
  const cleaned={};
  for(const [k,v] of Object.entries(vars)) if(String(k).startsWith('--')) cleaned[k]=String(v);
  if(!Object.keys(cleaned).length) throw new Error('No hay variables CSS (--...)');
  return cleaned;
}
$('#applyJson').addEventListener('click', ()=>{
  try{ const obj=JSON.parse($('#themeJson').value); setTheme(normalizeTheme(obj), false); toast('Tema JSON aplicado ‚úÖ'); }
  catch(e){ toast('JSON inv√°lido ‚ö†Ô∏è'); }
});
$('#copyJson').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText($('#themeJson').value); toast('JSON copiado ‚úÖ'); }
  catch{ $('#themeJson').focus(); $('#themeJson').select(); toast('Seleccionado (copia manual)'); }
});
$('#exportJson').addEventListener('click', ()=>{
  const data=JSON.stringify(themeExportObj(), null, 2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='triki-theme.json';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),1500);
});
$('#importJson').addEventListener('click', ()=>$('#themeFile').click());
$('#themeFile').addEventListener('change', (e)=>{
  const f=e.target.files && e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{ setTheme(normalizeTheme(JSON.parse(String(r.result||''))), false); toast('Tema importado ‚úÖ'); }catch{ toast('Archivo inv√°lido ‚ö†Ô∏è'); } };
  r.readAsText(f); e.target.value='';
});

// Sound modal
$('#applySound').addEventListener('click', ()=>{
  settings.sound=$('#sound').value; save('triki-settings', settings);
  closeModal(); toast('Sonido actualizado');
});

// Bottom nav
$('#navTheme').addEventListener('click', ()=>{ syncThemeUI(); openModal('theme'); });
$('#navSettings').addEventListener('click', ()=>{ syncSettingsUI(); openModal('settings'); });
$('#navSound').addEventListener('click', ()=>{ syncSettingsUI(); openModal('sound'); });
$('#navGame').addEventListener('click', ()=>{ syncSettingsUI(); openModal('settings'); });
$('#navStyle').addEventListener('click', ()=>{
  const isNight = (themeVars['--bg1']||'').toLowerCase()===(PRESETS.find(p=>p.name==='Night').vars['--bg1']).toLowerCase();
  setTheme(isNight ? PRESETS.find(p=>p.name==='Pink').vars : PRESETS.find(p=>p.name==='Night').vars, false);
  toast(isNight ? 'Modo claro' : 'Modo noche');
});

// Init
applyTheme(themeVars); syncSettingsUI(); syncThemeUI();
render(); scheduleAI();
</script>
</body>
</html>
