<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRIKI ‚Äî Tres en Raya</title>
  <!--
    Juego de tres en raya (triki) con opciones avanzadas de personalizaci√≥n.
    Este archivo combina todo el HTML, CSS y JavaScript en un √∫nico documento
    para facilitar su publicaci√≥n en servicios est√°ticos como GitHub Pages.
    
    Funciones implementadas:
    - Tablero 3√ó3 con estilos glass/ne√≥n.
    - IA b√°sica con modo Jugador vs IA y IA vs IA (autoplay).
    - Panel de ajustes para:
        * Cambiar colores (temas) mediante variables CSS.
        * Ajustar animaciones (activar/desactivar).
        * Ajustar espaciado y radio de las celdas.
        * Personalizar el tama√±o de las marcas (X/O) y sus colores.
        * Activar/desactivar sonido y ajustar volumen.
    - Importar/exportar temas en formato JSON.
    - Pantalla de registro/inicio de sesi√≥n local (guardada en localStorage).
  -->
  <style>
    :root{
      /* Colores base del fondo */
      --bg1:#6c2bd9;
      --bg2:#b02bd9;
      /* Colores de los paneles */
      --panel:#ff56e0;
      --panel2:#ff7cf0;
      /* Efectos glass */
      --glass: rgba(255,255,255,.16);
      --glass2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.25);
      /* Tipograf√≠a */
      --text:#ffffff;
      --muted: rgba(255,255,255,.78);
      /* Colores de X y O */
      --x:#3a3f95;
      --o:#ffffff;
      /* Imagen de fondo personalizada (url(...) o none) */
      --wallpaper:none;
      /* Ajustes de tablero */
      --cell-gap:18px;
      --cell-radius:18px;
      --cell-size:78px;
      --board-border:2px;
      /* Ajuste de escala de las marcas (1 = tama√±o normal) */
      --mark-scale:1;
      /* Animaciones: 1 = activadas, 0 = desactivadas */
      --anim-enabled:1;
      /* Sonido */
      --volume:0.2;
      /* Navegaci√≥n inferior */
      --navH:78px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      min-height:100vh;
      /* Fondo degradado; la imagen personalizada se aplica din√°micamente via JS */
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:18px 14px calc(var(--navH) + 14px + env(safe-area-inset-bottom,0px));
    }
    .app{width:min(520px,100%);}
    .hidden{display:none !important;}
    /* Encabezado */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:14px;
      margin-top:8px;
    }
    .title h1{margin:0;font-size:54px;letter-spacing:.5px;font-weight:900;line-height:.95;}
    .title .sub{margin-top:10px;font-size:24px;color:var(--muted);font-weight:500;}
    /* Tarjeta principal */
    .card{
      margin-top:22px;
      border-radius:28px;
      background:linear-gradient(180deg,color-mix(in srgb,var(--panel2) 86%,white 14%),var(--panel));
      box-shadow:0 18px 60px rgba(0,0,0,.28);
      border:var(--board-border) solid color-mix(in srgb,var(--glass2) 70%,transparent);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    /* Pastilla de turno */
    .turnPillWrap{display:flex;justify-content:center;margin-top:6px;}
    .turnPill{
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:12px 26px;
      border-radius:999px;
      background:color-mix(in srgb,var(--glass) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 90%,transparent);
      box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--glass2) 90%,transparent);
      font-weight:900;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .turnPill .mark{
      display:inline-grid;
      place-items:center;
      min-width:34px;height:34px;
      border-radius:999px;
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 70%,transparent);
      font-size:22px;font-weight:1000;
    }
    /* Tablero */
    .boardShell{
      margin-top:18px;
      border-radius:30px;
      padding:18px;
      background:color-mix(in srgb,var(--glass) 92%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 70%,transparent);
      box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--glass2) 85%,transparent);
    }
    .board{
      width:100%;
      aspect-ratio:1/1;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:var(--cell-gap);
      padding:10px;
      border-radius:26px;
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 65%,transparent);
    }
    .cell{
      border-radius:var(--cell-radius);
      background:color-mix(in srgb,var(--glass) 92%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 78%,transparent);
      box-shadow:0 18px 34px rgba(0,0,0,.10);
      display:grid;
      place-items:center;
      min-height:var(--cell-size);
      font-weight:1000;
      font-size:clamp(34px,8vw,54px);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      transition:transform .15s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      position:relative;
      overflow:hidden;
    }
    .anim-off .cell{transition:none !important;}
    .cell:hover{transform:translateY(-1px);background:color-mix(in srgb,var(--glass) 110%,transparent);border-color:color-mix(in srgb,var(--stroke) 92%,transparent);}
    .cell:active{transform:translateY(0px) scale(.98);}
    .cell.disabled{cursor:not-allowed;opacity:.78;}
    .cell.win{background:color-mix(in srgb,var(--glass) 145%,transparent);border-color:color-mix(in srgb,var(--stroke) 140%,transparent);box-shadow:0 24px 44px rgba(0,0,0,.16);}
    .markX{color:var(--x);text-shadow:0 10px 22px rgba(0,0,0,.20);transform:scale(var(--mark-scale));}
    .markO{color:var(--o);text-shadow:0 10px 22px rgba(0,0,0,.20);transform:scale(var(--mark-scale));}
    /* Botones */
    .buttons{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-top:16px;}
    .btn{
      border-radius:18px;
      padding:18px 12px;
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 60%,transparent);
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      color:var(--text);
      font-weight:900;
      font-size:28px;
      box-shadow:0 16px 34px rgba(0,0,0,.14);
      cursor:pointer;
      transition:transform .15s ease, background .18s ease, border-color .18s ease;
    }
    .btn:hover{transform:translateY(-1px);background:color-mix(in srgb,var(--glass) 78%,transparent);border-color:color-mix(in srgb,var(--stroke) 80%,transparent);}
    .btn:active{transform:translateY(0px) scale(.98);}
    .btn.smallText{font-size:22px;}
    /* Marcador */
    .score{margin-top:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    .scoreCard{
      border-radius:18px;
      padding:14px 12px;
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      border:var(--board-border) solid color-mix(in srgb,var(--stroke) 58%,transparent);
      box-shadow:0 12px 26px rgba(0,0,0,.10);
      text-align:center;
    }
    .scoreCard .label{font-size:20px;margin-bottom:4px;color:var(--muted);}    
    .scoreCard .value{font-size:28px;font-weight:900;}
    /* Barra inferior */
    .nav{
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      height:calc(var(--navH) + env(safe-area-inset-bottom,0px));
      padding-bottom:env(safe-area-inset-bottom,0px);
      background:color-mix(in srgb,var(--navBg) 100%,transparent);
      backdrop-filter:blur(12px);
      display:flex;
      justify-content:space-around;
      align-items:center;
      border-top:1px solid color-mix(in srgb,var(--stroke) 45%,transparent);
      box-shadow:0 -10px 20px rgba(0,0,0,.25);
      z-index:10;
    }
    .nav button{
      appearance:none;
      background:color-mix(in srgb,var(--navBtnBg) 100%,transparent);
      border:2px solid color-mix(in srgb,var(--stroke) 50%,transparent);
      border-radius:16px;
      padding:12px;
      color:var(--text);
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background .18s ease,border-color .18s ease;
    }
    .nav button.active, .nav button:hover{
      background:color-mix(in srgb,var(--navBtnBgActive) 100%,transparent);
      border-color:color-mix(in srgb,var(--stroke) 80%,transparent);
    }
    /* Modales */
    .modal{
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      display:none;
      justify-content:center;
      align-items:center;
      background:rgba(0,0,0,.5);
      z-index:11;
    }
    .modal.active{display:flex;}
    .modalCard{
      background:color-mix(in srgb,var(--panel2) 86%,white 14%);
      border-radius:28px;
      padding:20px;
      max-width:90%;
      width:480px;
      max-height:90vh;
      overflow:auto;
      position:relative;
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.30);
    }
    .modalCard h2{margin-top:0;font-size:32px;}
    .closeBtn{
      position:absolute;
      top:12px;right:12px;
      background:none;
      border:none;
      color:var(--text);
      font-size:28px;
      cursor:pointer;
    }
    .modalCard label{display:block;margin-top:14px;font-size:16px;color:var(--muted);}    
    .modalCard input[type="number"], .modalCard input[type="text"], .modalCard input[type="password"], .modalCard input[type="color"], .modalCard select{
      width:100%;
      margin-top:6px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid color-mix(in srgb,var(--stroke) 60%,transparent);
      background:color-mix(in srgb,var(--glass2) 100%,transparent);
      color:var(--text);
      font-size:16px;
    }
    .modalCard input[type="checkbox"]{margin-right:8px;}
    .modalCard button{margin-top:20px;width:100%;padding:10px;border-radius:12px;background:color-mix(in srgb,var(--navBtnBg) 100%,transparent);border:2px solid color-mix(in srgb,var(--stroke) 50%,transparent);color:var(--text);font-size:18px;cursor:pointer;transition:background .18s ease,border-color .18s ease;}
    .modalCard button:hover{background:color-mix(in srgb,var(--navBtnBgActive) 100%,transparent);border-color:color-mix(in srgb,var(--stroke) 80%,transparent);}
    .sectionTitle{margin-top:24px;font-weight:700;font-size:18px;color:var(--text);}    
    /* Autenticaci√≥n */
    #authGate{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #authGate.hidden{display:none;}
    #authGateCard{
      background:color-mix(in srgb,var(--panel2) 86%,white 14%);
      border-radius:28px;
      padding:24px;
      max-width:90%;
      width:400px;
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.30);
    }
    #authGateCard h2{margin-top:0;font-size:28px;}
    #authGateCard input{width:100%;margin-top:10px;padding:10px;border-radius:8px;border:1px solid color-mix(in srgb,var(--stroke) 60%,transparent);background:color-mix(in srgb,var(--glass2) 100%,transparent);color:var(--text);font-size:16px;}
    #authGateCard button{width:100%;margin-top:16px;padding:12px;border-radius:12px;background:color-mix(in srgb,var(--navBtnBg) 100%,transparent);border:2px solid color-mix(in srgb,var(--stroke) 50%,transparent);color:var(--text);font-size:18px;cursor:pointer;transition:background .18s ease,border-color .18s ease;}
    #authGateCard button:hover{background:color-mix(in srgb,var(--navBtnBgActive) 100%,transparent);border-color:color-mix(in srgb,var(--stroke) 80%,transparent);}
  </style>
</head>
<body>
  <!-- Autenticaci√≥n -->
  <div id="authGate">
    <div id="authGateCard">
      <h2 id="authTitle">Crear cuenta</h2>
      <input id="authUser" type="text" placeholder="Usuario" />
      <input id="authPass" type="password" placeholder="Contrase√±a" />
      <button id="authBtn">Crear cuenta</button>
      <p id="authMsg" style="margin-top:10px;color:#ffcccc;font-size:14px;display:none;"></p>
    </div>
  </div>
  <!-- Aplicaci√≥n principal -->
  <div class="app hidden" id="app">
    <div class="top">
      <div class="title">
        <h1>TRIKI</h1>
        <div class="sub">Tres en Raya</div>
      </div>
    </div>
    <div class="card">
      <!-- Turno -->
      <div class="turnPillWrap">
        <div class="turnPill"><span>TURNO:</span> <span class="mark" id="turnMark">X</span></div>
      </div>
      <!-- Tablero -->
      <div class="boardShell">
        <div class="board" id="board">
          <!-- Las celdas se generan din√°micamente -->
        </div>
      </div>
      <!-- Botones principales -->
      <div class="buttons">
        <button class="btn" id="btnReset">Reiniciar</button>
        <button class="btn" id="btnNext">Nueva Ronda</button>
        <button class="btn" id="btnResetAll">Reiniciar Todo</button>
      </div>
      <!-- Marcador -->
      <div class="score">
        <div class="scoreCard">
          <div class="label">X</div>
          <div class="value" id="scoreX">0</div>
        </div>
        <div class="scoreCard">
          <div class="label">Empates</div>
          <div class="value" id="scoreD">0</div>
        </div>
        <div class="scoreCard">
          <div class="label">O</div>
          <div class="value" id="scoreO">0</div>
        </div>
      </div>
    </div>
    <!-- Barra inferior de navegaci√≥n -->
    <div class="nav">
      <button id="homeBtn" class="active">üè†</button>
      <button id="settingsBtn">‚öôÔ∏è</button>
      <button id="themeBtn">üé®</button>
      <button id="soundBtn">üîä</button>
    </div>
  </div>
  <!-- Modal de Ajustes del Juego -->
  <div class="modal" id="settingsModal">
    <div class="modalCard">
      <button class="closeBtn" id="closeSettings">‚úï</button>
      <h2>Ajustes</h2>
      <label>Modo de Juego
        <select id="modeSelect">
          <option value="pvsp">2 Jugadores (local)</option>
          <option value="pvai">Jugador vs IA</option>
          <option value="aivsa">IA vs IA (autoplay)</option>
        </select>
      </label>
      <label>Tiempo de espera IA (ms)
        <input type="number" id="aiDelay" value="600" min="100" step="100" />
      </label>
      <label>Animaciones activadas
        <input type="checkbox" id="animEnabled" checked />
      </label>
      <label>Espacio entre celdas (px)
        <input type="number" id="gapInput" value="18" min="0" max="40" />
      </label>
      <label>Radio de celdas (px)
        <input type="number" id="radiusInput" value="18" min="0" max="40" />
      </label>
      <label>Tama√±o ficha (escala)
        <input type="number" id="markScaleInput" value="1" step="0.1" min="0.5" max="2" />
      </label>
      <label>Color X
        <input type="color" id="colorX" value="#3a3f95" />
      </label>
      <label>Color O
        <input type="color" id="colorO" value="#ffffff" />
      </label>
      <button id="applySettings">Aplicar</button>
      <button id="resetSettings">Restaurar valores</button>

      <!-- Bot√≥n para volver a la pantalla principal -->
      <button id="backSettings">Volver</button>
    </div>
  </div>
  <!-- Modal de Temas -->
  <div class="modal" id="themeModal">
    <div class="modalCard">
      <button class="closeBtn" id="closeTheme">‚úï</button>
      <h2>Tema</h2>
      <p>Colores actuales. Cambia y guarda tu propio tema:</p>
      <label>Color fondo arriba
        <input type="color" id="themeBg1" value="#6c2bd9" />
      </label>
      <label>Color fondo abajo
        <input type="color" id="themeBg2" value="#b02bd9" />
      </label>
      <label>Panel principal
        <input type="color" id="themePanel" value="#ff56e0" />
      </label>
      <label>Panel secundario
        <input type="color" id="themePanel2" value="#ff7cf0" />
      </label>
      <button id="applyTheme">Aplicar tema</button>
      <button id="resetTheme">Restaurar tema</button>
      <div class="sectionTitle">Tema en JSON (importar / exportar)</div>
      <label>Editor JSON
        <textarea id="themeJson" rows="6" style="width:100%;margin-top:8px;padding:10px;border-radius:8px;background:color-mix(in srgb,var(--glass2) 100%,transparent);border:1px solid color-mix(in srgb,var(--stroke) 60%,transparent);color:var(--text);"></textarea>
      </label>
      <button id="applyThemeJson">Aplicar JSON</button>
      <button id="copyThemeJson">Copiar JSON</button>
      <button id="exportThemeJson">Exportar .json</button>
      <input type="file" id="importThemeFile" accept="application/json" style="display:none;" />
      <button id="importThemeJson">Importar .json</button>

      <!-- Fondo personalizado -->
      <div class="sectionTitle">Fondo de pantalla</div>
      <button id="selectWallpaper">Seleccionar imagen</button>
      <button id="clearWallpaper">Quitar fondo</button>
      <input type="file" id="wallpaperInput" accept="image/*" style="display:none;" />

      <!-- Bot√≥n para volver a la pantalla principal -->
      <button id="backTheme">Volver</button>
    </div>
  </div>
  <!-- Modal de Sonido -->
  <div class="modal" id="soundModal">
    <div class="modalCard">
      <button class="closeBtn" id="closeSound">‚úï</button>
      <h2>Sonido</h2>
      <label>Audio activado
        <input type="checkbox" id="soundEnabled" checked />
      </label>
      <label>Volumen
        <input type="number" id="soundVolume" min="0" max="1" step="0.05" value="0.2" />
      </label>
      <button id="applySound">Aplicar</button>

      <!-- Bot√≥n para volver a la pantalla principal -->
      <button id="backSound">Volver</button>
    </div>
  </div>
  <script>
    // Estado del juego y configuraci√≥n
    const state = {
      board:Array(9).fill(''),
      turn:'X',
      scores:{X:0,O:0,D:0},
      settings:{
        mode:'pvsp',
        aiDelay:600,
        anim:true,
        cellGap:18,
        cellRadius:18,
        markScale:1,
        xColor:'#3a3f95',
        oColor:'#ffffff',
        theme:{bg1:'#6c2bd9',bg2:'#b02bd9',panel:'#ff56e0',panel2:'#ff7cf0',wallpaper:''},
        sound:{enabled:true,volume:0.2}
      },
      lastMove:null,
      playing:true
    };

    // Claves de localStorage
    const STORAGE_USER='trikiUser';
    const STORAGE_PWD='trikiPwd';
    const STORAGE_SETTINGS='trikiSettings';

    // Dom
    const boardEl=document.getElementById('board');
    const turnMark=document.getElementById('turnMark');
    const scoreX=document.getElementById('scoreX');
    const scoreO=document.getElementById('scoreO');
    const scoreD=document.getElementById('scoreD');
    const appEl=document.getElementById('app');
    const authGate=document.getElementById('authGate');
    const authTitle=document.getElementById('authTitle');
    const authUser=document.getElementById('authUser');
    const authPass=document.getElementById('authPass');
    const authBtn=document.getElementById('authBtn');
    const authMsg=document.getElementById('authMsg');
    // Modales
    const settingsModal=document.getElementById('settingsModal');
    const themeModal=document.getElementById('themeModal');
    const soundModal=document.getElementById('soundModal');
    // Nav
    const homeBtn=document.getElementById('homeBtn');
    const settingsBtn=document.getElementById('settingsBtn');
    const themeBtn=document.getElementById('themeBtn');
    const soundBtn=document.getElementById('soundBtn');
    // Ajustes UI
    const modeSelect=document.getElementById('modeSelect');
    const aiDelay=document.getElementById('aiDelay');
    const animEnabled=document.getElementById('animEnabled');
    const gapInput=document.getElementById('gapInput');
    const radiusInput=document.getElementById('radiusInput');
    const markScaleInput=document.getElementById('markScaleInput');
    const colorX=document.getElementById('colorX');
    const colorO=document.getElementById('colorO');
    const applySettingsBtn=document.getElementById('applySettings');
    const resetSettingsBtn=document.getElementById('resetSettings');
    // Tema UI
    const themeBg1=document.getElementById('themeBg1');
    const themeBg2=document.getElementById('themeBg2');
    const themePanel=document.getElementById('themePanel');
    const themePanel2=document.getElementById('themePanel2');
    const applyThemeBtn=document.getElementById('applyTheme');
    const resetThemeBtn=document.getElementById('resetTheme');
    const themeJson=document.getElementById('themeJson');
    const applyThemeJsonBtn=document.getElementById('applyThemeJson');
    const copyThemeJsonBtn=document.getElementById('copyThemeJson');
    const exportThemeJsonBtn=document.getElementById('exportThemeJson');
    const importThemeJsonBtn=document.getElementById('importThemeJson');
    const importThemeFile=document.getElementById('importThemeFile');
    // Fondo UI
    const selectWallpaper=document.getElementById('selectWallpaper');
    const clearWallpaper=document.getElementById('clearWallpaper');
    const wallpaperInput=document.getElementById('wallpaperInput');
    // Botones de volver en modales
    const backSettings=document.getElementById('backSettings');
    const backTheme=document.getElementById('backTheme');
    const backSound=document.getElementById('backSound');
    // Sonido UI
    const soundEnabled=document.getElementById('soundEnabled');
    const soundVolume=document.getElementById('soundVolume');
    const applySoundBtn=document.getElementById('applySound');

    // Registro/inicio de sesi√≥n
    function hash(str){
      // Sencillo hash alfanum√©rico (no seguro). Convierte cadena a base64.
      return btoa(str);
    }
    function checkAuth(){
      const user=localStorage.getItem(STORAGE_USER);
      const pwd=localStorage.getItem(STORAGE_PWD);
      // Reiniciar campos y mensaje
      authUser.value='';
      authPass.value='';
      authMsg.style.display='none';
      if(!user||!pwd){
        // No hay cuenta, mostrar registro
        authTitle.textContent='Crear cuenta';
        authBtn.textContent='Crear cuenta';
      }else{
        // Hay cuenta guardada, mostrar inicio de sesi√≥n
        authTitle.textContent='Iniciar sesi√≥n';
        authBtn.textContent='Iniciar sesi√≥n';
      }
      authGate.classList.remove('hidden');
    }
    authBtn.addEventListener('click',()=>{
      const u=authUser.value.trim();
      const p=authPass.value.trim();
      if(!u||!p){authMsg.textContent='Completa usuario y contrase√±a';authMsg.style.display='block';return;}
      const storedUser=localStorage.getItem(STORAGE_USER);
      const storedPwd=localStorage.getItem(STORAGE_PWD);
      if(!storedUser){
        // Crear cuenta
        localStorage.setItem(STORAGE_USER,u);
        localStorage.setItem(STORAGE_PWD,hash(p));
        authGate.classList.add('hidden');
        appEl.classList.remove('hidden');
        initGame();
      }else{
        // Iniciar sesi√≥n
        if(u===storedUser && hash(p)===storedPwd){
          authGate.classList.add('hidden');
          appEl.classList.remove('hidden');
          initGame();
        }else{
          authMsg.textContent='Credenciales incorrectas';authMsg.style.display='block';
        }
      }
    });

    // Juego
    function initGame(){
      // Cargar configuraci√≥n guardada
      const saved=localStorage.getItem(STORAGE_SETTINGS);
      if(saved){
        try{
          const obj=JSON.parse(saved);
          Object.assign(state.settings,obj);
        }catch(e){}
      }
      applySettingsToUI();
      applyThemeToUI();
      applySoundToUI();
      applyCssVars();
      // Construir tablero
      boardEl.innerHTML='';
      state.board=Array(9).fill('');
      for(let i=0;i<9;i++){
        const cell=document.createElement('div');
        cell.className='cell';
        cell.dataset.index=i;
        cell.addEventListener('click',()=>handleCell(i));
        boardEl.appendChild(cell);
      }
      updateUI();
      maybeAiTurn();
    }

    function handleCell(i){
      if(!state.playing) return;
      if(state.board[i]) return;
      state.board[i]=state.turn;
      state.lastMove=i;
      updateUI();
      if(checkWinner(state.turn)){
        state.playing=false;
        if(state.turn==='X') state.scores.X++; else state.scores.O++;
        updateScore();
        setTimeout(()=>nextRound(),800);
        playSfx('win');
        return;
      }
      if(state.board.every(v=>v)){
        state.playing=false;
        state.scores.D++;
        updateScore();
        setTimeout(()=>nextRound(),800);
        playSfx('draw');
        return;
      }
      // Cambiar turno
      state.turn=state.turn==='X'?'O':'X';
      updateTurnUI();
      maybeAiTurn();
    }

    function checkWinner(player){
      const b=state.board;
      const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      return wins.some(([a,b2,c])=>b[a]===player && b[b2]===player && b[c]===player);
    }
    function nextRound(){
      state.board=Array(9).fill('');
      state.playing=true;
      state.turn='X';
      state.lastMove=null;
      updateUI();
      maybeAiTurn();
    }
    function resetGame(){
      state.scores={X:0,O:0,D:0};
      nextRound();
    }
    // IA simple: mueve aleatoriamente
    function aiMove(){
      const empty=state.board.map((v,i)=>v?null:i).filter(v=>v!==null);
      if(!empty.length) return;
      const idx=empty[Math.floor(Math.random()*empty.length)];
      handleCell(idx);
    }
    function maybeAiTurn(){
      if(!state.playing) return;
      if(state.settings.mode==='pvsp') return;
      const isAiTurn=(state.settings.mode==='pvai' && state.turn==='O') || (state.settings.mode==='aivsa');
      if(isAiTurn){
        setTimeout(()=>{
          aiMove();
          if(state.settings.mode==='aivsa' && state.playing){
            // en autoplay, deja que la IA siga moviendo autom√°ticamente
            maybeAiTurn();
          }
        },state.settings.aiDelay);
      }
    }
    // Actualizar la interfaz
    function updateUI(){
      const cells=boardEl.children;
      for(let i=0;i<9;i++){
        const cell=cells[i];
        cell.textContent=state.board[i];
        cell.classList.remove('markX','markO','win');
        if(state.board[i]==='X') cell.classList.add('markX');
        if(state.board[i]==='O') cell.classList.add('markO');
      }
      updateTurnUI();
    }
    function updateTurnUI(){
      turnMark.textContent=state.turn;
    }
    function updateScore(){
      scoreX.textContent=state.scores.X;
      scoreO.textContent=state.scores.O;
      scoreD.textContent=state.scores.D;
    }
    // Aplicar configuraci√≥n CSS
    function applyCssVars(){
      const r=document.documentElement.style;
      r.setProperty('--cell-gap',state.settings.cellGap+'px');
      r.setProperty('--cell-radius',state.settings.cellRadius+'px');
      r.setProperty('--cell-size',state.settings.cellSize?state.settings.cellSize+'px':state.settings.cellRadius*4+'px');
      r.setProperty('--mark-scale',state.settings.markScale);
      r.setProperty('--x',state.settings.xColor);
      r.setProperty('--o',state.settings.oColor);
      r.setProperty('--bg1',state.settings.theme.bg1);
      r.setProperty('--bg2',state.settings.theme.bg2);
      r.setProperty('--panel',state.settings.theme.panel);
      r.setProperty('--panel2',state.settings.theme.panel2);
      // Fondo personalizado: establecer variable y aplicar imagen de fondo al body
      if(state.settings.theme.wallpaper){
        r.setProperty('--wallpaper',`url(${state.settings.theme.wallpaper})`);
      }else{
        r.setProperty('--wallpaper','none');
      }
      // Aplicar imagen de fondo directamente para garantizar que se vea
      const grad=`linear-gradient(180deg, ${state.settings.theme.bg1} 0%, ${state.settings.theme.bg2} 100%)`;
      if(state.settings.theme.wallpaper){
        document.body.style.backgroundImage = `${grad}, url(${state.settings.theme.wallpaper})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundRepeat = 'no-repeat';
      }else{
        document.body.style.backgroundImage = grad;
        document.body.style.backgroundSize = '';
        document.body.style.backgroundPosition = '';
        document.body.style.backgroundRepeat = '';
      }
      r.setProperty('--anim-enabled',state.settings.anim?1:0);
      document.body.classList.toggle('anim-off',!state.settings.anim);
    }
    // Ajustes -> cargar valores en formulario
    function applySettingsToUI(){
      modeSelect.value=state.settings.mode;
      aiDelay.value=state.settings.aiDelay;
      animEnabled.checked=state.settings.anim;
      gapInput.value=state.settings.cellGap;
      radiusInput.value=state.settings.cellRadius;
      markScaleInput.value=state.settings.markScale;
      colorX.value=state.settings.xColor;
      colorO.value=state.settings.oColor;
    }
    // Tema -> cargar valores
    function applyThemeToUI(){
      themeBg1.value=state.settings.theme.bg1;
      themeBg2.value=state.settings.theme.bg2;
      themePanel.value=state.settings.theme.panel;
      themePanel2.value=state.settings.theme.panel2;
      // actualizar json
      updateThemeJson();
    }
    function applySoundToUI(){
      soundEnabled.checked=state.settings.sound.enabled;
      soundVolume.value=state.settings.sound.volume;
    }
    // Guardar configuraci√≥n
    function saveSettings(){
      localStorage.setItem(STORAGE_SETTINGS,JSON.stringify(state.settings));
    }
    // Sonido simple con Web Audio API
    let audioCtx;
    function playTone(freq,dur){
      if(!state.settings.sound.enabled) return;
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const osc=audioCtx.createOscillator();
      const gain=audioCtx.createGain();
      osc.type='square';
      osc.frequency.value=freq;
      gain.gain.value=state.settings.sound.volume;
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime+dur);
    }
    function playSfx(type){
      if(type==='win') playTone(440,0.3);
      else if(type==='draw') playTone(180,0.2);
      else playTone(300,0.1);
    }
    // Eventos botones de navegaci√≥n
    function closeAllModals(){
      settingsModal.classList.remove('active');
      themeModal.classList.remove('active');
      soundModal.classList.remove('active');
    }
    homeBtn.addEventListener('click',()=>{closeAllModals();homeBtn.classList.add('active');settingsBtn.classList.remove('active');themeBtn.classList.remove('active');soundBtn.classList.remove('active');});
    settingsBtn.addEventListener('click',()=>{closeAllModals();settingsModal.classList.add('active');settingsBtn.classList.add('active');homeBtn.classList.remove('active');themeBtn.classList.remove('active');soundBtn.classList.remove('active');});
    themeBtn.addEventListener('click',()=>{closeAllModals();themeModal.classList.add('active');themeBtn.classList.add('active');homeBtn.classList.remove('active');settingsBtn.classList.remove('active');soundBtn.classList.remove('active');});
    soundBtn.addEventListener('click',()=>{closeAllModals();soundModal.classList.add('active');soundBtn.classList.add('active');homeBtn.classList.remove('active');settingsBtn.classList.remove('active');themeBtn.classList.remove('active');});
    // Cerrar con bot√≥n ‚úï
    document.getElementById('closeSettings').onclick=()=>{settingsModal.classList.remove('active');settingsBtn.classList.remove('active');homeBtn.classList.add('active');};
    document.getElementById('closeTheme').onclick=()=>{themeModal.classList.remove('active');themeBtn.classList.remove('active');homeBtn.classList.add('active');};
    document.getElementById('closeSound').onclick=()=>{soundModal.classList.remove('active');soundBtn.classList.remove('active');homeBtn.classList.add('active');};
    // Botones principales
    document.getElementById('btnReset').onclick=()=>{nextRound();};
    document.getElementById('btnNext').onclick=()=>{nextRound();};
    document.getElementById('btnResetAll').onclick=()=>{resetGame();};
    // Aplicar y restaurar ajustes
    applySettingsBtn.addEventListener('click',()=>{
      state.settings.mode=modeSelect.value;
      state.settings.aiDelay=parseInt(aiDelay.value)||600;
      state.settings.anim=animEnabled.checked;
      state.settings.cellGap=parseInt(gapInput.value)||18;
      state.settings.cellRadius=parseInt(radiusInput.value)||18;
      state.settings.markScale=parseFloat(markScaleInput.value)||1;
      state.settings.xColor=colorX.value;
      state.settings.oColor=colorO.value;
      applyCssVars();
      saveSettings();
      nextRound();

      // Cerrar modal y volver a la pantalla principal
      settingsModal.classList.remove('active');
      settingsBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    resetSettingsBtn.addEventListener('click',()=>{
      state.settings={...state.settings,mode:'pvsp',aiDelay:600,anim:true,cellGap:18,cellRadius:18,markScale:1,xColor:'#3a3f95',oColor:'#ffffff'};
      applySettingsToUI();
      applyCssVars();
      saveSettings();
      nextRound();
    });
    // Tema: aplicar y resetear
    applyThemeBtn.addEventListener('click',()=>{
      state.settings.theme.bg1=themeBg1.value;
      state.settings.theme.bg2=themeBg2.value;
      state.settings.theme.panel=themePanel.value;
      state.settings.theme.panel2=themePanel2.value;
      applyCssVars();
      applyThemeToUI();
      saveSettings();

      // Cerrar modal y volver a la pantalla principal
      themeModal.classList.remove('active');
      themeBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    resetThemeBtn.addEventListener('click',()=>{
      state.settings.theme={bg1:'#6c2bd9',bg2:'#b02bd9',panel:'#ff56e0',panel2:'#ff7cf0'};
      applyCssVars();
      applyThemeToUI();
      saveSettings();
    });
    // Tema JSON helper
    function updateThemeJson(){
      const json={name:'Mi tema',version:1,vars:{
        '--bg1':state.settings.theme.bg1,
        '--bg2':state.settings.theme.bg2,
        '--panel':state.settings.theme.panel,
        '--panel2':state.settings.theme.panel2,
        '--x':state.settings.xColor,
        '--o':state.settings.oColor,
        '--wallpaper':state.settings.theme.wallpaper||''
      }};
      themeJson.value=JSON.stringify(json,null,2);
    }
    applyThemeJsonBtn.addEventListener('click',()=>{
      try{
        const obj=JSON.parse(themeJson.value);
        const vars=obj.vars||obj;
        if(vars['--bg1']) state.settings.theme.bg1=vars['--bg1'];
        if(vars['--bg2']) state.settings.theme.bg2=vars['--bg2'];
        if(vars['--panel']) state.settings.theme.panel=vars['--panel'];
        if(vars['--panel2']) state.settings.theme.panel2=vars['--panel2'];
        if(vars['--x']) state.settings.xColor=vars['--x'];
        if(vars['--o']) state.settings.oColor=vars['--o'];
        if(vars['--wallpaper']!==undefined){
          // Asignar wallpaper; si es cadena vac√≠a se elimina
          state.settings.theme.wallpaper = vars['--wallpaper'] || '';
        }
        applyCssVars();
        applySettingsToUI();
        applyThemeToUI();
        saveSettings();

        // Cerrar modal y volver a la pantalla principal
        themeModal.classList.remove('active');
        themeBtn.classList.remove('active');
        homeBtn.classList.add('active');
      }catch(e){alert('JSON inv√°lido');}
    });
    copyThemeJsonBtn.addEventListener('click',()=>{
      navigator.clipboard.writeText(themeJson.value).then(()=>{alert('Tema copiado en el portapapeles');});
    });
    exportThemeJsonBtn.addEventListener('click',()=>{
      const blob=new Blob([themeJson.value],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='triki-theme.json';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    });
    importThemeJsonBtn.addEventListener('click',()=>{importThemeFile.click();});
    importThemeFile.addEventListener('change',e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=function(ev){themeJson.value=ev.target.result;applyThemeJsonBtn.click();};
      reader.readAsText(file);
    });

    // Fondo personalizado
    selectWallpaper.addEventListener('click',()=>{
      wallpaperInput.click();
    });
    wallpaperInput.addEventListener('change',e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=function(ev){
        state.settings.theme.wallpaper=ev.target.result;
        applyCssVars();
        updateThemeJson();
        saveSettings();
      };
      reader.readAsDataURL(file);
    });
    clearWallpaper.addEventListener('click',()=>{
      state.settings.theme.wallpaper='';
      applyCssVars();
      updateThemeJson();
      saveSettings();
    });

    // Navegaci√≥n: botones de volver en modales
    backSettings.addEventListener('click',()=>{
      settingsModal.classList.remove('active');
      settingsBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    backTheme.addEventListener('click',()=>{
      themeModal.classList.remove('active');
      themeBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    backSound.addEventListener('click',()=>{
      soundModal.classList.remove('active');
      soundBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    // Sonido
    applySoundBtn.addEventListener('click',()=>{
      state.settings.sound.enabled=soundEnabled.checked;
      state.settings.sound.volume=parseFloat(soundVolume.value)||0.2;
      saveSettings();

      // Cerrar modal y volver a la pantalla principal
      soundModal.classList.remove('active');
      soundBtn.classList.remove('active');
      homeBtn.classList.add('active');
    });
    // Guardar tema/json al cambiar colores
    themeBg1.addEventListener('change',updateThemeJson);
    themeBg2.addEventListener('change',updateThemeJson);
    themePanel.addEventListener('change',updateThemeJson);
    themePanel2.addEventListener('change',updateThemeJson);
    colorX.addEventListener('change',()=>{state.settings.xColor=colorX.value;applyCssVars();updateThemeJson();saveSettings();});
    colorO.addEventListener('change',()=>{state.settings.oColor=colorO.value;applyCssVars();updateThemeJson();saveSettings();});
    // Iniciar autenticaci√≥n cuando cargue la p√°gina
    document.addEventListener('DOMContentLoaded',()=>{
      checkAuth();
    });
  </script>
</body>
</html>